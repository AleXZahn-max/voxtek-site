<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="VoxTek Enterprises - The future of secure technology.">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>VoxTek Enterprises | Submission is Safety</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f3ff">
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --bg-color: #020202;
            --text-main: #e0e0e0;
            --vox-cyan: #00f3ff;
            --vox-cyan-dim: rgba(0, 243, 255, 0.1);
            --vox-blue: #0044ff;
            --alert-red: #ff003c;
            --alastor-red: #8a0000;
            --panel-bg: rgba(5, 8, 12, 0.95);
            --font-tech: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-code: 'Courier New', monospace;
            --scan-line-color: rgba(0, 243, 255, 0.03);
        }

        /* THEMES */
        body.theme-val {
            --vox-cyan: #ff00ff;
            --vox-cyan-dim: rgba(255, 0, 255, 0.1);
            --vox-blue: #aa00aa;
            --scan-line-color: rgba(255, 0, 255, 0.03);
        }
        
        body.theme-radio {
            --vox-cyan: #ff0000;
            --vox-cyan-dim: rgba(255, 0, 0, 0.4);
            --vox-blue: #330000;
            --bg-color: #1a0000;
            filter: contrast(1.5) sepia(1) hue-rotate(-50deg) saturate(3);
            animation: worldShake 0.1s infinite;
            overflow: hidden !important;
            pointer-events: none;
        }
        
        @keyframes worldShake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        html { scroll-behavior: smooth; }
        
        @media (prefers-reduced-motion: reduce) {
            html { scroll-behavior: auto; }
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-tech); cursor: crosshair; }
        
        button, a, input, .sq, .tech-card, .logo-container, input[type="range"] { cursor: pointer; }
        input[type="text"] { cursor: text; }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            overflow-x: hidden; width: 100vw; min-height: 100vh;
            background-image: 
                linear-gradient(var(--scan-line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--scan-line-color) 1px, transparent 1px);
            background-size: 30px 30px;
            scrollbar-width: thin;
            scrollbar-color: var(--vox-cyan) #000;
            transition: all 0.5s ease;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
            overscroll-behavior-y: none;
        }

        /* --- 2. CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; background: #000; }
        ::-webkit-scrollbar-track { border-left: 1px solid #222; }
        ::-webkit-scrollbar-thumb { background: var(--vox-cyan); border-radius: 0; box-shadow: 0 0 10px var(--vox-cyan); border: 1px solid black; }
        ::-webkit-scrollbar-thumb:hover { background: white; }

        /* --- 3. FX LAYERS --- */
        .crt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 9000; }
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,20,40,0.8) 100%); pointer-events: none; z-index: 8999; }

        /* --- 4. EASTER EGG --- */
        #easterEggLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 100000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden;
        }
        #easterEggLayer.active { display: flex; }

        .hypno-spiral {
            width: 100vw; height: 100vw;
            background: repeating-conic-gradient(from 0deg, #000 0deg 10deg, var(--vox-cyan) 10deg 20deg);
            border-radius: 50%;
            animation: spinHypno 2s infinite linear;
            opacity: 0.3; position: absolute;
        }
        .egg-text {
            font-size: 100px; font-weight: 900; color: white; z-index: 2;
            text-shadow: 0 0 20px var(--vox-cyan); text-transform: uppercase;
            animation: textPulse 0.1s infinite; text-align: center;
            padding: 0 20px;
        }
        @keyframes spinHypno { to { transform: rotate(360deg); } }
        @keyframes textPulse { 0% { transform: scale(1); color: white; } 50% { transform: scale(1.05); color: var(--vox-cyan); } 100% { transform: scale(1); color: white; } }

        /* --- 5. VSOD --- */
        #vsod-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #8a0000;
            color: white; font-family: 'Courier New', monospace;
            z-index: 2147483647;
            display: none; flex-direction: column;
            padding: 10% 100px; font-size: 20px; line-height: 1.5;
            cursor: none; user-select: none;
            pointer-events: auto !important;
        }
        #vsod-layer.active { display: flex; animation: flashRed 0.2s; }
        @keyframes flashRed { 0% { background: #fff; } 100% { background: #8a0000; } }
        
        .sad-face { font-size: 150px; margin-bottom: 40px; transform: rotate(90deg); display:inline-block; }
        
        .glitch-bar {
            width: 100%; height: 5px; background: white; position: absolute; top: 50%; left: 0;
            animation: scanKill 2s infinite; opacity: 0.5;
        }
        @keyframes scanKill { 0% { top: 0%; } 100% { top: 100%; } }

        /* --- 6. WEBCAM --- */
        #cam-container {
            position: fixed; bottom: 20px; left: 20px; width: 160px; height: 120px;
            border: 2px solid var(--vox-cyan); background: #000;
            z-index: 5000; display: none; flex-direction: column;
            box-shadow: 0 0 15px var(--vox-cyan);
        }
        #cam-container video { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; filter: grayscale(100%) contrast(1.2); }
        #cam-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid rgba(255,255,255,0.2); pointer-events: none; }
        .cam-label { background: var(--vox-cyan); color: #000; font-size: 10px; padding: 2px 5px; font-weight: bold; position: absolute; top: 0; left: 0; }
        .rec-dot { width: 8px; height: 8px; background: red; border-radius: 50%; position: absolute; top: 5px; right: 5px; animation: blink 1s infinite; }

        /* --- 7. UI ELEMENTS --- */
        #notification-area { position: fixed; top: 80px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; max-width: 90vw; }
        .vox-toast {
            background: rgba(0, 0, 0, 0.95); border-left: 4px solid var(--vox-cyan); padding: 15px 25px;
            color: white; font-family: var(--font-code); font-size: 13px; min-width: 300px; max-width: 100%;
            box-shadow: 0 0 20px var(--vox-cyan-dim); transform: translateX(100%);
            animation: slideIn 0.3s forwards; pointer-events: auto; position: relative;
        }
        .vox-toast.error { border-left-color: var(--alert-red); }
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes blink { 50% { opacity: 0; } }

        /* Header */
        header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 50px; margin-top: 35px;
            background: rgba(5, 5, 5, 0.85); border-bottom: 1px solid rgba(0, 243, 255, 0.2); 
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); 
            flex-wrap: wrap; 
        }
        .logo-container { display: flex; align-items: center; text-decoration: none; }
        .vox-logo-svg { width: 45px; height: 45px; margin-right: 15px; filter: drop-shadow(0 0 5px var(--vox-cyan)); }
        .logo { font-size: 26px; font-weight: 900; letter-spacing: 3px; color: white; text-transform: uppercase; }
        .logo span { color: var(--vox-cyan); }
        nav ul { display: flex; gap: 30px; list-style: none; flex-wrap: wrap; align-items: center;}
        nav a { color: #aaa; text-decoration: none; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; transition: 0.3s; font-weight: 700; position: relative; display: inline-block; padding: 5px; }
        nav a:hover, nav a:focus { color: var(--vox-cyan); text-shadow: 0 0 10px var(--vox-cyan); outline: none; }
        nav a::after { content:''; position:absolute; bottom:-5px; left:0; width:0; height:2px; background:var(--vox-cyan); transition:0.3s; }
        nav a:hover::after, nav a:focus::after { width:100%; }

        /* Sections */
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.8s ease; }
        .reveal.active { opacity: 1; transform: translateY(0); }
        .section-header { text-align: center; margin: 120px 0 60px; padding: 0 10px; }
        .section-header h2 { font-size: 40px; color: white; text-transform: uppercase; letter-spacing: 5px; display: inline-block; position: relative; word-wrap: break-word; max-width: 100%; }
        .section-header h2::after { content:''; display:block; width: 50%; height: 3px; background: var(--vox-cyan); margin: 15px auto 0; box-shadow: 0 0 10px var(--vox-cyan); }

        /* Hero */
        .hero { height: 90vh; min-height: 600px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; padding: 0 20px; }
        .hero h1 { font-size: 8vw; line-height: 0.9; text-transform: uppercase; font-weight: 900; margin-bottom: 20px; color: white; position: relative; display: inline-block; text-shadow: 4px 4px 0px rgba(0, 243, 255, 0.1); }
        @media (min-width: 1200px) { .hero h1 { font-size: 100px; } }
        
        .glitch-text::before, .glitch-text::after { 
            content: attr(data-text); 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: transparent; 
            opacity: 0.8; pointer-events: none; 
        }
        .glitch-text::before { color: var(--vox-cyan); z-index: -1; animation: glitch 3s infinite reverse; }
        .glitch-text::after { color: #ff00ff; z-index: -2; animation: glitch 2s infinite; }
        @keyframes glitch { 0% { clip-path: inset(0 0 0 0); transform: translate(0); } 20% { clip-path: inset(20% 0 10% 0); transform: translate(-2px, 2px); } 100% { clip-path: inset(0 0 0 0); transform: translate(0); } }
        
        .btn-tech {
            background: transparent; border: 1px solid var(--vox-cyan); color: var(--vox-cyan);
            padding: 15px 40px; font-weight: bold; text-transform: uppercase; letter-spacing: 3px;
            cursor: pointer; position: relative; transition: 0.3s; text-decoration: none; display: inline-block;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }
        .btn-tech:hover { background: var(--vox-cyan); color: black; box-shadow: 0 0 40px var(--vox-cyan); outline: none; }

        /* Timeline */
        .timeline-container { max-width: 800px; margin: 0 auto; position: relative; border-left: 2px solid #333; padding-left: 40px; padding-right: 20px; }
        .timeline-item { margin-bottom: 50px; position: relative; }
        .timeline-item::before { content:''; position: absolute; left: -46px; top: 0; width: 10px; height: 10px; background: var(--vox-cyan); border-radius: 50%; box-shadow: 0 0 10px var(--vox-cyan); }
        .t-date { color: var(--vox-cyan); font-family: var(--font-code); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .t-title { color: white; font-size: 20px; text-transform: uppercase; margin-bottom: 10px; font-weight: bold; }
        .t-desc { color: #888; line-height: 1.6; }

        /* Products */
        .products-grid { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; padding: 0 20px; }
        .tech-card {
            background: var(--panel-bg); border: 1px solid #333; padding: 40px; width: 350px; max-width: 100%;
            position: relative; transition: 0.4s; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .tech-card:hover { border-color: var(--vox-cyan); transform: translateY(-10px); }
        .badge { position: absolute; top: 0; right: 0; background: var(--vox-blue); color: white; padding: 5px 15px; font-size: 10px; font-weight: bold; clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%); }

        /* Reviews */
        .reviews-wrapper { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 50px; padding: 0 20px; }
/* --- ОПТИМИЗАЦИЯ ШРИФТОВ ДЛЯ МОБИЛЬНЫХ (ANDROID) --- */
        @media (max-width: 768px) {
            /* 1. Общий текст сайта */
            body {
                font-size: 14px; 
            }

            /* 2. Заголовки секций ( About, Tech и т.д.) */
            .section-header h2 {
                font-size: 24px !important; 
            }

            /* 3. Текст в мессенджере (Vox Network) */
            .msg-bubble {
                font-size: 12px; /* Было 14px */
                padding: 8px 12px;
            }

            .msg-name {
                font-size: 9px;
            }

            .c-name {
                font-size: 13px;
            }

            /* 4. Кнопки в настройках профиля */
            .p-card .btn-tech {
                font-size: 11px;
                padding: 10px 5px;
            }

            /* 5. Поля ввода (чтобы клавиатура не увеличивала масштаб) */
            .form-input {
                font-size: 14px;
            }
        }
        
        .review-form { background: var(--panel-bg); border: 1px solid var(--vox-cyan); padding: 40px; height: fit-content; }
        .form-label { display: block; color: var(--vox-cyan); font-size: 11px; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }
        .form-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 15px; font-family: var(--font-code); outline: none; transition: 0.3s; margin-bottom: 20px; }
        .form-input:focus { border-color: var(--vox-cyan); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        
        .rating-squares { display: flex; gap: 5px; cursor: pointer; margin-bottom: 20px; }
        .sq { width: 40px; height: 40px; border: 1px solid #555; transition: 0.2s; position: relative; } 
        @media (min-width: 769px) { .sq { width: 25px; height: 25px; } }
        .sq:focus { outline: 2px solid var(--vox-cyan); }
        .sq.active { background: var(--vox-cyan); border-color: var(--vox-cyan); box-shadow: 0 0 10px var(--vox-cyan); }

        .review-feed { display: flex; flex-direction: column; gap: 20px; max-height: 600px; overflow-y: auto; padding-right: 10px; }
        .review-item { background: rgba(255,255,255,0.03); border-left: 3px solid #333; padding: 20px; animation: slideIn 0.5s; }
        .review-item.good { border-left-color: var(--vox-cyan); }
        .review-item.bad { border-left-color: var(--alert-red); }
        .r-name { font-weight: bold; color: white; font-size: 14px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 5px; }
        .r-squares { display: flex; gap: 2px; }
        .r-sq { width: 8px; height: 8px; background: #333; }
        .r-sq.fill { background: var(--vox-cyan); }
        .r-text { color: #aaa; font-style: italic; margin-top: 10px; font-size: 13px; word-break: break-word; }

        /* Terminal */
        .terminal-wrapper { padding: 80px 0; background: #000; display: flex; justify-content: center; border-top: 1px solid #222; border-bottom: 1px solid #222; }
        .terminal-box { 
            width: 900px; max-width: 95vw; border: 1px solid var(--vox-cyan); background: rgba(5, 5, 8, 0.98);
            font-family: var(--font-code); box-shadow: 0 0 50px rgba(0, 243, 255, 0.05); display: flex; flex-direction: column;
        }
        .term-bar { background: #111; padding: 8px 15px; color: #666; font-size: 11px; display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        .term-screen { height: 400px; padding: 20px; color: var(--vox-cyan); font-size: 14px; overflow-y: auto; }
        .term-input { display: flex; padding: 15px; background: #050505; border-top: 1px solid #333; align-items: center; }
        #cmdInput { background: transparent; border: none; color: white; width: 100%; outline: none; font-family: var(--font-code); font-size: 14px; margin-left: 10px; }
        .matrix-rain { color: #0f0; opacity: 0.5; font-size: 12px; }

        /* Eye */
        .vox-eye-container { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; z-index: 5000; transition: transform 0.2s; pointer-events: auto; cursor: pointer; }
        @media (hover: none) and (pointer: coarse) { .vox-eye-container { display: none; } }
        
        .eye-svg { width: 100%; height: 100%; filter: drop-shadow(0 0 10px var(--vox-cyan)); }
        .pupil-group { transition: transform 0.05s; will-change: transform; }
        
        .news-ticker { background: var(--vox-cyan); color: black; font-weight: 900; font-family: var(--font-code); padding: 5px 0; border-bottom: 2px solid var(--vox-blue); position: fixed; top: 0; width: 100%; z-index: 9000; font-size: 13px; white-space: nowrap; overflow: hidden; }
        .ticker-move { display: inline-block; animation: tick 30s infinite linear; will-change: transform; }
        @keyframes tick { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        footer { text-align: center; padding: 60px 20px; color: #444; font-size: 11px; border-top: 1px solid #111; background: #010101; }
        
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        /* Mobile */
        @media (max-width: 768px) {
            header { flex-direction: column; gap: 20px; padding: 15px; }
            nav ul { justify-content: center; gap: 15px; }
            .hero h1 { font-size: 40px; }
            .section-header h2 { font-size: 28px; }
            .timeline-container { padding-left: 25px; }
            .timeline-item::before { left: -29px; }
            .btn-tech { padding: 15px 20px; width: 100%; text-align: center; }
            #notification-area { top: 60px; left: 10px; right: 10px; width: auto; align-items: center; }
            .vox-toast { min-width: auto; width: 100%; }
            #cam-container { width: 100px; height: 75px; bottom: 10px; left: 10px; }
            #vsod-layer { padding: 50px 20px; }
            .egg-text { font-size: 50px; }
            
            /* Slide Menu Mobile */
            #slide-music-menu { width: 90vw !important; right: -95vw !important; }
            #slide-music-menu.open { right: 0 !important; }
        }

        /* --- SUBPAGE STYLES --- */
        .view-section { display: none; width: 100%; min-height: 80vh; padding-top: 40px; }
        .view-section.active-view { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MESSENGER STYLES (UPDATED FOR VOX NETWORK) --- */
        .messenger-container {
            max-width: 1000px; margin: 40px auto; 
            border: 1px solid var(--vox-cyan); background: rgba(5, 5, 8, 0.95);
            height: 700px; display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(0,243,255,0.1);
            position: relative;
        }
        
        .auth-screen { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { width: 300px; text-align: center; }
        .auth-tabs { display: flex; margin-bottom: 20px; width: 100%; border-bottom: 1px solid #333; }
        .auth-tab { flex: 1; padding: 10px; background: transparent; border: none; color: #666; font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: var(--vox-cyan); border-bottom: 2px solid var(--vox-cyan); }
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.3s; }

        .chat-ui { width: 100%; height: 100%; display: none; overflow: hidden; }
        .chat-ui.active { display: flex; }
        
        /* SIDEBAR (Contacts) */
        .chat-sidebar { 
            width: 280px; border-right: 1px solid #333; background: #030303; 
            display: flex; flex-direction: column; 
            transition: transform 0.3s ease;
        }
        .user-list { flex: 1; overflow-y: auto; }
        
        .contact-item { padding: 15px; border-bottom: 1px solid #111; display: flex; align-items: center; gap: 10px; transition: 0.2s; cursor: pointer; position: relative; }
        .contact-item:hover { background: #111; }
        .contact-item.active { background: rgba(0,243,255,0.1); border-left: 3px solid var(--vox-cyan); }
        .c-avatar { 
            width: 40px; height: 40px; background: #222; border-radius: 50%; 
            display:flex; justify-content:center; align-items:center; overflow:hidden; border: 1px solid #444;
        }
        .c-avatar img { width:100%; height:100%; object-fit:cover; }
        .c-info { flex: 1; overflow: hidden; }
        .c-name { font-size: 14px; color: white; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-status { font-size: 10px; color: #666; }
        .c-status.online { color: var(--vox-cyan); }

        .unread-badge {
            background: var(--alert-red); color: white; font-size: 9px; 
            font-weight: bold; border-radius: 50%; width: 18px; height: 18px; 
            display: flex; justify-content: center; align-items: center;
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            box-shadow: 0 0 5px red;
        }

        /* MAIN CHAT AREA */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        
        .chat-header { 
            padding: 15px; border-bottom: 1px solid #333; background: #080808; 
            display: flex; justify-content: space-between; align-items: center; height: 60px;
        }
        .chat-header-info { display:flex; align-items:center; gap:10px; }
        .chat-title { color:white; font-weight:bold; font-size: 16px; display: flex; flex-direction: column; }
        .typing-indicator { font-size: 9px; color: var(--vox-cyan); font-style: italic; opacity: 0; transition: opacity 0.3s; }
        .typing-indicator.active { opacity: 1; animation: pulseType 1s infinite; }
        @keyframes pulseType { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg-wrapper { display: flex; gap: 10px; max-width: 80%; animation: fadeIn 0.3s; }
        .msg-wrapper.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; cursor: pointer; }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .msg-content { display: flex; flex-direction: column; gap: 2px; }
        .msg-name { font-size: 10px; color: #888; font-weight: bold; cursor: pointer; }
        .msg-name:hover { color: var(--vox-cyan); }
        .msg-bubble { 
            padding: 10px 15px; border-radius: 8px; font-size: 14px; line-height: 1.4; word-wrap: break-word;
            background: #151515; border: 1px solid #333; color: #ccc;
        }
        .msg-wrapper.me .msg-bubble { background: rgba(0,243,255,0.1); border-color: var(--vox-cyan); color: white; }
        .msg-time { font-size: 9px; color: #555; text-align: right; margin-top: 2px; }

        .chat-input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; background: #050505; align-items: center; }
        
        /* SETTINGS MODAL - ИСПРАВЛЕННЫЙ */
        .profile-modal {
            position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95);
            z-index: 10; display:none; flex-direction:column; justify-content:center; align-items:center;
        }
        .profile-modal.active { display:flex; }
        .p-card { 
            width: 300px; 
            max-width: 90vw; /* Защита для маленьких экранов */
            padding: 20px; 
            border: 1px solid var(--vox-cyan); 
            background: #050505; 
            box-sizing: border-box; /* КРИТИЧНО: держит всё внутри */
        }
        
        /* Исправление для ряда кнопок */
        .p-card div[style*="display:flex"] {
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        
        .p-card .btn-tech {
            flex: 1;
            padding: 10px 5px; /* Уменьшаем боковые отступы */
            font-size: 12px;
            white-space: nowrap;
        }

        /* MOBILE CHAT */
        .mobile-menu-btn { display: none; background:none; border:none; color:white; font-size:20px; margin-right:10px; }
        
        @media (max-width: 768px) {
            .messenger-container { height: calc(100vh - 140px); border:none; width:100%; margin-top: 10px; }
            .mobile-menu-btn { display: block; }
            .chat-sidebar { 
                position: absolute; left: 0; top: 0; height: 100%; z-index: 20;
                transform: translateX(-100%); width: 85%; border-right: 2px solid var(--vox-cyan);
                background: black;
            }
            .chat-sidebar.open { transform: translateX(0); }
            .msg-wrapper { max-width: 90%; }
        }

        /* --- VIDEO PLAYER STYLES --- */
        .video-wrapper {
            max-width: 900px; margin: 40px auto; 
            border: 2px solid #333; background: #000;
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transition: all 0.3s;
        }
        
        .video-wrapper:fullscreen {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: black; border: none; cursor: none;
        }
        .video-wrapper:fullscreen.user-active { cursor: default; }
        .video-wrapper:fullscreen .video-screen-container { height: 100%; width: 100%; border: none; }
        .video-wrapper:fullscreen video { object-fit: contain; }
        
        .video-wrapper:fullscreen .video-controls-panel, 
        .video-wrapper:fullscreen + .playlist-container { display: none !important; }

        .video-wrapper:fullscreen .custom-video-controls {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.6); padding-bottom: 20px;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .video-wrapper:fullscreen.user-active .custom-video-controls { opacity: 1; pointer-events: auto; }

        .video-screen-container {
            width: 100%; aspect-ratio: 16/9; background: #050505; position: relative; overflow: hidden;
            border-bottom: 1px solid #333;
        }
        .video-overlay-crt {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 5;
            animation: scanlineMove 10s linear infinite;
        }
        @keyframes scanlineMove {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        #staticCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; opacity: 0.15; mix-blend-mode: screen;
        }

        .video-tag {
            position: absolute; top: 10px; left: 10px; background: var(--vox-cyan); color: black;
            font-weight: bold; font-size: 10px; padding: 2px 5px; z-index: 6; font-family: var(--font-code);
        }
        #customVideoPlayer { width: 100%; height: 100%; outline: none; display:block; z-index: 2; position: relative; }
        
        .custom-video-controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid var(--vox-cyan);
            padding: 10px; z-index: 2147483647; 
            display: flex; flex-direction: column; gap: 5px;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .video-wrapper:hover .custom-video-controls, 
        .custom-video-controls:hover { transform: translateY(0); }
        
        .c-row { display: flex; align-items: center; gap: 15px; }
        
        .c-btn {
            background: transparent; border: 1px solid #444; color: var(--vox-cyan);
            font-family: var(--font-code); font-size: 12px; font-weight: bold;
            padding: 5px 10px; min-width: 30px; text-align: center;
        }
        .c-btn:hover { background: var(--vox-cyan); color: black; border-color: var(--vox-cyan); }
        .c-time { font-family: var(--font-code); font-size: 11px; color: #aaa; min-width: 100px; }
        
        .vox-range { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #222; outline: none; flex: 1; border: 1px solid #333; }
        .vox-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 10px; height: 14px; background: var(--vox-cyan); cursor: pointer; box-shadow: 0 0 5px var(--vox-cyan); }
        
        /* Android Touch Targets */
        @media (max-width: 768px) {
            .vox-range { height: 10px; }
            .vox-range::-webkit-slider-thumb { width: 20px; height: 20px; }
            .c-btn { padding: 10px; }
        }

        .video-controls-panel { padding: 20px; display: flex; justify-content: center; gap: 20px; align-items: center; background: #080808; }
        .file-upload-btn { position: relative; overflow: hidden; display: inline-block; }
        .file-upload-btn input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        .playlist-container {
            border: 1px solid #333; background: #050505; padding: 10px;
            max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px;
        }
        .playlist-item {
            padding: 5px 10px; background: #111; color: #aaa; font-size: 11px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .playlist-item:hover { background: #222; color: white; }
        .playlist-item.active { background: rgba(0, 243, 255, 0.1); color: var(--vox-cyan); border-left: 2px solid var(--vox-cyan); }
        .playlist-remove { color: var(--alert-red); font-weight: bold; padding: 0 5px; }
        .playlist-remove:hover { color: white; }

        /* --- SLIDE OUT MUSIC MENU --- */
        #slide-music-menu {
            position: fixed; top: 80px; right: -320px; width: 300px; height: auto; max-height: 80vh;
            background: rgba(5, 8, 12, 0.98); border: 1px solid var(--vox-cyan); border-right: none;
            z-index: 9500; transition: right 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px); overflow-y: auto;
        }
        #slide-music-menu.open { right: 0; }
        
        .music-header { font-size: 14px; font-weight: bold; color: var(--vox-cyan); border-bottom: 1px solid #333; padding-bottom: 10px; display:flex; justify-content:space-between;}
        
        .visualizer-container {
            width: 100%; height: 60px; background: #000; border: 1px solid #333;
            display: flex; align-items: flex-end; justify-content: space-between; padding: 2px;
        }
        #audioCanvas { width: 100%; height: 100%; }
        
        .cover-art-box {
            width: 100%; height: 200px; background: #111; border: 1px solid #333;
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        #coverImg { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; filter: grayscale(100%); transition:0.3s; }
        .cover-art-box:hover #coverImg { opacity: 1; filter: grayscale(0%); }
        .cover-text { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 10px; text-align: center; }

        .music-controls { display: flex; flex-direction: column; gap: 10px; }
        .range-wrap { display: flex; align-items: center; gap: 10px; font-size: 10px; color: #666; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: #333; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 10px; height: 10px; background: var(--vox-cyan); cursor: pointer; box-shadow: 0 0 5px var(--vox-cyan); }

        #toggleMenuBtn {
            position: absolute; left: -40px; top: 0; width: 40px; height: 40px;
            background: var(--vox-cyan); border: none; color: black; font-weight: bold;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 10px 50%);
        }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            .crt-overlay, .vignette { display: none !important; }
            header, #slide-music-menu { backdrop-filter: none !important; background: rgba(0, 0, 0, 0.95) !important; }
            .tech-card, .btn-tech, .vox-toast { box-shadow: none !important; border: 1px solid var(--vox-cyan); }
            body.theme-radio { animation: none !important; filter: none !important; background: #330000; }
            .btn-tech, nav a { min-height: 44px; display: flex; align-items: center; justify-content: center; }
            .video-wrapper:fullscreen { background: #000; }
        }

        /* Частицы курсора (0 и 1) */
        .cursor-particle {
            position: fixed; top: 0; left: 0; font-family: var(--font-code); font-size: 10px; color: var(--vox-cyan);
            pointer-events: none; z-index: 9999; opacity: 1; animation: particleFade 1s forwards;
        }
        body.theme-radio .cursor-particle { color: red; font-family: 'Courier New', serif; }
        @keyframes particleFade { 0% { transform: translateY(0) scale(1); opacity: 0.8; } 100% { transform: translateY(20px) scale(0.5); opacity: 0; } }

        /* ОПТИМИЗИРОВАННАЯ ПУЛЬСАЦИЯ */
        .vox-eye-container.listening .eye-svg { stroke: var(--vox-cyan); stroke-width: 3px; will-change: transform; animation: eyePulse 1.5s infinite alternate; }
        .vox-eye-container.listening::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%;
            box-shadow: 0 0 20px var(--vox-cyan); opacity: 0.5; z-index: -1; animation: glowPulse 1.5s infinite alternate;
        }
        @keyframes eyePulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        @keyframes glowPulse { from { opacity: 0.3; transform: scale(0.8); } to { opacity: 0.6; transform: scale(1.2); } }

        #adminPanel {
            display: none; /* Скрыто по умолчанию */
            flex-direction: column;
            gap: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            max-width: 90vw;
            background: rgba(5, 10, 15, 0.98); /* Синеватый черный фон */
            border: 2px solid var(--vox-cyan); /* СИНИЙ БОРДЮР */
            padding: 30px;
            z-index: 20000;
            /* СИНЕЕ СВЕЧЕНИЕ */
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.3), inset 0 0 20px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        
        #adminPanel h3 {
            text-align: center;
            letter-spacing: 3px;
            /* СИНИЙ ТЕКСТ И АНИМАЦИЯ */
            color: var(--vox-cyan);
            border-bottom: 1px solid var(--vox-cyan);
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px var(--vox-cyan);
        }

        @keyframes blinkRed {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px red; }
            50% { opacity: 0.5; text-shadow: none; }
        }
        /* ADMIN USER LIST */
        .admin-user-list {
            max-height: 250px;
            overflow-y: auto;
            background: #050505;
            border: 1px solid #333;
            margin-top: 10px;
            padding: 5px;
        }
        .admin-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #222;
            font-size: 11px;
            color: #aaa;
        }
        .admin-row:hover { background: rgba(255, 0, 0, 0.1); color: white; }
        .ban-btn {
            background: var(--alert-red);
            color: black;
            border: none;
            font-weight: bold;
            padding: 2px 8px;
            font-family: var(--font-code);
            font-size: 10px;
        }
        .ban-btn:hover { background: white; color: red; }
        .banned-tag { color: red; font-weight: bold; border: 1px solid red; padding: 0 5px; }

        /* --- 8. NEW: BLUE ADMIN THEME & MODALS --- */
        #adminPanel.blue-mode {
            border-color: var(--vox-cyan);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.3), inset 0 0 20px rgba(0, 243, 255, 0.1);
        }
        #adminPanel.blue-mode h3 {
            color: var(--vox-cyan);
            border-bottom-color: var(--vox-cyan);
            text-shadow: 0 0 10px var(--vox-cyan);
            animation: none;
        }
        
        /* Custom Modals (Replacements for alert/confirm) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        
        .vox-modal {
            background: #050505; border: 1px solid var(--vox-cyan);
            width: 400px; max-width: 90%; padding: 20px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            position: relative;
        }
        .vox-modal h3 { color: var(--vox-cyan); margin-bottom: 15px; font-size: 18px; text-transform: uppercase; }
        .vox-modal p { font-size: 14px; color: #ccc; margin-bottom: 25px; line-height: 1.5; }
        .vox-modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Video Call Interface */
        .call-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 15000; display: none;
            flex-direction: column;
        }
        .call-overlay.active { display: flex; }
        
        .call-video-grid {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        /* --- Аватар во время звонка (когда нет видео) --- */
        .avatar-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #050505; z-index: 1; /* Поверх видео, но под локальным видео */
            gap: 20px;
        }
        .call-avatar-img {
            width: 120px; height: 120px; border-radius: 50%;
            border: 3px solid var(--vox-cyan);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            object-fit: cover;
            animation: pulseAvatar 2s infinite;
        }
        .call-avatar-name {
            font-size: 24px; color: white; font-weight: bold;
            text-shadow: 0 0 10px var(--vox-cyan);
            text-transform: uppercase; letter-spacing: 2px;
        }
        .call-status-label {
            font-size: 12px; color: #666; font-family: var(--font-code);
            margin-top: 5px;
        }
        @keyframes pulseAvatar {
            0% { box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); }
            50% { box-shadow: 0 0 50px rgba(0, 243, 255, 0.5); }
            100% { box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); }
        }
        /* Скрываем аватар, когда он не нужен */
        .avatar-overlay.hidden { display: none; }

        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo {
            position: absolute; bottom: 20px; right: 20px;
            width: 150px; height: 100px; background: #222;
            border: 2px solid var(--vox-cyan); object-fit: cover;
            z-index: 2;
        }
        
        .call-controls {
            height: 80px; background: #111; display: flex; justify-content: center; align-items: center; gap: 20px;
            border-top: 1px solid #333;
        }
        .btn-call {
            width: 60px; height: 60px; border-radius: 50%; border: 1px solid #333; 
            font-size: 0; /* Скрываем текст */
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.3s; background: rgba(0,0,0,0.8);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }
        .btn-call svg { width: 24px; height: 24px; fill: white; transition: 0.3s; }
        
        .btn-hangup { border-color: var(--alert-red); background: rgba(50, 0, 0, 0.5); }
        .btn-hangup svg { fill: var(--alert-red); }
        .btn-hangup:hover { background: var(--alert-red); box-shadow: 0 0 20px var(--alert-red); }
        .btn-hangup:hover svg { fill: black; }
        
        .btn-mute { border-color: var(--vox-cyan); }
        .btn-mute svg { fill: var(--vox-cyan); }
        .btn-mute:hover { background: var(--vox-cyan); }
        .btn-mute:hover svg { fill: black; }

        /* Состояние выключенного микрофона/камеры */
        .btn-mute.off { border-color: #555; background: #222; }
        .btn-mute.off svg { fill: #777; }

        /* Admin Message Tools */
        .msg-tools { margin-left: auto; display: flex; gap: 5px; opacity: 0.5; font-size: 10px; }
        .msg-tools button { background: none; border: 1px solid #444; color: #666; cursor: pointer; }
        .msg-tools button:hover { color: var(--vox-cyan); border-color: var(--vox-cyan); }

        /* --- ОПТИМИЗАЦИЯ И ПУЛЬСАЦИЯ --- */
        
        /* 1. Пульсация для входящего звонка */
        #incomingCallModal .vox-modal {
            animation: modalPulse 1.5s infinite alternate;
            border-width: 2px;
            display: flex; flex-direction: column; align-items: center;
        }
        @keyframes modalPulse {
            0% { box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); border-color: rgba(0, 243, 255, 0.5); }
            100% { box-shadow: 0 0 60px rgba(0, 243, 255, 0.8); border-color: #fff; }
        }

        /* 2. Аватарка в модальном окне */
        .modal-caller-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 2px solid var(--vox-cyan);
            margin-bottom: 15px;
            object-fit: cover;
            box-shadow: 0 0 15px var(--vox-cyan);
        }

        /* 3. ОПТИМИЗАЦИЯ ДЛЯ ANDROID / МОБИЛЬНЫХ */
        @media (max-width: 768px) {
            /* Отключаем тяжелые эффекты */
            .crt-overlay, .vignette, .cursor-particle { display: none !important; }
            
            /* Увеличиваем шрифты */
            body { font-size: 16px; } 
            .btn-tech { padding: 15px; min-height: 50px; font-size: 14px; }
            .form-input { font-size: 16px; padding: 12px; }
            
            /* Адаптация модалок */
            .vox-modal { width: 95%; padding: 15px; }
            
            /* Исправляем чат */
            .messenger-container { height: calc(100vh - 80px); margin-top: 10px; border: none; }
            .chat-header { padding: 10px; }
            .msg-bubble { font-size: 15px; padding: 12px; }
            
            /* Скрываем глаз (он тормозит скролл на телефоне) */
            .vox-eye-container { display: none; }
        }
        /* --- НОВЫЕ СТИЛИ (IMAGE CHAT, TRUST SCORE, SPY) --- */
        .chat-img-btn {
            font-size: 20px; padding: 0 10px; background: none; border: none; color: #666; transition: 0.3s;
        }
        .chat-img-btn:hover { color: var(--vox-cyan); transform: scale(1.1); }

        .msg-image {
            max-width: 250px; border-radius: 5px; border: 1px solid var(--vox-cyan); margin-top: 5px;
            cursor: pointer; transition: 0.3s;
        }
        .msg-image:hover { opacity: 0.8; }

        .trust-badge {
            font-size: 10px; padding: 2px 5px; background: #111; border: 1px solid #333; margin-left: 5px;
            color: white; font-weight: bold; font-family: var(--font-code);
        }
        .trust-high { color: #0f0; border-color: #0f0; }
        .trust-low { color: var(--alert-red); border-color: var(--alert-red); }

        /* Сетка для шпионского режима */
        .spy-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
            max-height: 200px; overflow-y: auto; margin-top: 10px;
        }
        .spy-card {
            background: #000; border: 1px solid #333; padding: 10px; font-size: 10px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .spy-card.active { border-color: var(--alert-red); animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 5px #500; } 50% { box-shadow: 0 0 15px #f00; } 100% { box-shadow: 0 0 5px #500; } }
    </style>
</head>
<body id="top">

    <div class="crt-overlay" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>
    <div id="notification-area" aria-live="polite"></div>

    <audio id="bg-music" src="embient.mp3" loop crossorigin="anonymous"></audio>

    <div id="vsod-layer">
        <div class="glitch-bar"></div>
        <div class="sad-face">:(</div>
        <h1 style="font-size: 50px; margin-bottom: 20px;">SIGNAL LOST</h1>
        <p>THE RADIO IS DEAD. LONG LIVE THE RADIO.</p>
        <p style="margin-top: 20px; color: #ff0000;" id="vsod-percent">System Corruption: 100%</p>
        <div style="margin-top: 50px; font-size: 14px; opacity: 0.8; border-top: 1px solid white; padding-top: 20px;">
            <p>Error: ALASTOR_INTERFERENCE_DETECTED</p>
            <p>Status: FATAL_EXCEPTION_0x666</p>
            <p>Action: PRAY</p>
        </div>
    </div>

    <div id="cam-container">
        <div class="cam-label">SUBJECT #8940</div>
        <div class="rec-dot"></div>
        <video id="webcamFeed" autoplay muted playsinline></video>
        <div id="cam-overlay"></div>
    </div>

    <div id="easterEggLayer" role="dialog" aria-modal="true" aria-label="Easter Egg Protocol VOX">
        <div class="hypno-spiral"></div>
        <div class="egg-text">TRUST US</div>
        <div class="egg-text" style="font-size: 40px; margin-top: 20px; animation-delay: 0.5s;">VOX IS WATCHING YOU</div>
        <button id="closeEasterEgg" class="btn-tech" style="z-index: 4; margin-top: 50px;">RESIST (ESC)</button>
    </div>

    <div class="news-ticker" role="marquee" aria-label="News Ticker">
        <div class="ticker-move">
            /// VOXTEK STOCK SURGES 666% /// DO NOT TRUST THE RADIO /// VIDEO IS THE FUTURE /// VANGUARD SYSTEM V10.0 RELEASED /// SUBMIT TO THE SIGNAL ///
        </div>
    </div>

    <div class="vox-eye-container" aria-hidden="true">
        <svg class="eye-svg" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" stroke="var(--vox-cyan)" stroke-width="2" fill="none" stroke-dasharray="10 5" />
            <circle cx="50" cy="50" r="30" fill="black" />
            <g class="pupil-group" id="eyePupil">
                <circle cx="50" cy="50" r="12" stroke="var(--vox-cyan)" stroke-width="2" fill="none"/>
                <circle cx="50" cy="50" r="5" fill="var(--alert-red)" />
            </g>
        </svg>
    </div>

    <div id="slide-music-menu">
        <button id="toggleMenuBtn" aria-label="Toggle Music Menu">♫</button>
        <div class="music-header">
            <span>VOXTEK AUDIO</span>
            <span style="font-size:10px;">V.2.0</span>
        </div>
        
        <div class="cover-art-box">
            <img id="coverImg" src="https://placehold.co/200x200/000000/00f3ff/png?text=VOX+BEATS" alt="Cover Art">
            <div class="cover-text"> </div>
            <label class="file-upload-btn" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.8); border:1px solid #333; padding:2px 5px; font-size:9px;">
                UPLOAD ART
                <input type="file" id="coverUpload" accept="image/*">
            </label>
        </div>

        <div class="visualizer-container">
            <canvas id="audioCanvas"></canvas>
        </div>

        <div class="music-controls">
            <div class="range-wrap">
                <span>VOL</span>
                <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.2">
            </div>
            <div class="range-wrap">
                <span>SEEK</span>
                <input type="range" id="seekControl" min="0" max="100" value="0">
            </div>
            <div style="display:flex; justify-content:space-between; font-family:var(--font-code); font-size:10px;">
                <span id="currentTime">00:00</span>
                <span id="durationTime">--:--</span>
            </div>
            <button class="btn-tech" id="playPauseBtn" style="padding:5px; font-size:12px; width:100%;">PLAY STREAM</button>
        </div>
        
        <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px;">
            <label class="btn-tech file-upload-btn" style="width:100%; font-size:10px; padding:8px; text-align:center;">
                ADD TO PLAYLIST
                <input type="file" id="localAudioInput" accept="audio/*" multiple>
            </label>
            <div id="audioPlaylist" class="playlist-container">
                </div>
        </div>
    </div>

    <header role="banner">
        <a href="#top" class="logo-container" onclick="Router.go('home')" aria-label="VoxTek Home">
            <svg class="vox-logo-svg" viewBox="0 0 100 100" aria-hidden="true">
                <path d="M10,10 L90,10 L80,80 L20,80 Z" stroke="var(--vox-cyan)" stroke-width="4" fill="none"/>
                <path d="M35,30 L50,65 L65,30" stroke="var(--vox-cyan)" stroke-width="5" fill="none" stroke-linecap="round"/>
                <circle cx="50" cy="65" r="5" fill="var(--vox-cyan)"/>
            </svg>
            <div class="logo">VOX<span>TEK</span></div>
        </a>
        
        <nav role="navigation">
            <ul>
                <li><a href="#about" onclick="Router.go('home')">About</a></li>
                <li><a href="#products" onclick="Router.go('home')">Tech</a></li>
                <li><a href="#terminal" onclick="Router.go('home')">Terminal</a></li>
                <li><a href="#" onclick="Router.go('video')" style="color:white;">BROADCAST</a></li>
                <li><a href="#" onclick="Router.go('messenger')" style="color:var(--vox-cyan);">MESSENGER</a></li>
                </ul>
        </nav>
    </header>

    <div id="view-home" class="view-section active-view">
        <main>
            <section class="hero" aria-label="Welcome">
                <h1 class="glitch-text" id="heroTitle" data-text="Trust Us With Your Technology">Trust Us With<br>Your Technology</h1>
                <p style="color: #bbb; margin-top: 20px; font-size: 18px; max-width: 600px; padding: 0 10px;">
                    The future is bright. The future is blue. <br> 
                    Welcome to a perfectly curated reality.
                </p>
                <button class="btn-tech" id="initBtn" style="margin-top:40px;">INITIATE CONTROL</button>
            </section>

            <section id="about" aria-labelledby="about-title">
                <div class="section-header"><h2 id="about-title">Our Vision</h2></div>
                <div class="timeline-container reveal">
                    <div class="timeline-item">
                        <div class="t-date">2019 - THE FALL</div>
                        <div class="t-title">Foundation</div>
                        <div class="t-desc">VoxTek is established in Pentagram City. The first television broadcast hypnotizes 10% of the population instantly.</div>
                    </div>
                    <div class="timeline-item">
                        <div class="t-date">2022 - THE SILENCE</div>
                        <div class="t-title">Radio Obsolescence</div>
                        <div class="t-desc">Old mediums are purged. VoxTek acquires 90% of all media outlets. Video becomes the only truth.</div>
                    </div>
                    <div class="timeline-item">
                        <div class="t-date">2026 - TOTALITY</div>
                        <div class="t-title">Vanguard System</div>
                        <div class="t-desc">Release of the Vanguard Neural Link. Security is now biological. We are inside your head. You are safe.</div>
                    </div>
                </div>
            </section>

            <section id="products" aria-labelledby="products-title">
                <div class="section-header"><h2 id="products-title">Systems</h2></div>
                <div class="products-grid reveal">
                    <div class="tech-card" tabindex="0">
                        <div class="badge">V10.0 STABLE</div>
                        <h3>VANGUARD BUILDER</h3>
                        <p>The ultimate CLI deployment tool. Compiles to C++, secures your code, and monitors your soul. Mandatory for all developers.</p>
                        <button type="button" class="btn-tech" id="downloadBtn" style="margin-top:20px; width:100%; text-align:center;">DOWNLOAD .EXE</button>
                    </div>
                    <div class="tech-card" tabindex="0">
                        <div class="badge">SOLD OUT</div>
                        <h3>VOX WATCH</h3>
                        <p>Monitors heart rate, location, and rebellious thoughts. Electric shock therapy included for free.</p>
                        <button class="btn-tech" style="margin-top:20px; width:100%; border-color:#555; color:#555; cursor:not-allowed;" disabled>RESTRICTED</button>
                    </div>
                </div>
            </section>

            <section id="reviews" aria-labelledby="reviews-title">
                <div class="section-header"><h2 id="reviews-title">Citizen Voices</h2></div>
                <div class="reviews-wrapper">
                    <div class="review-form reveal">
                        <h3 style="color:white; margin-bottom:20px; border-bottom:1px solid var(--vox-cyan); padding-bottom:10px;">SUBMIT REPORT</h3>
                        <form id="reviewForm" onsubmit="return false;">
                            <label for="revName" class="form-label">CITIZEN ID</label>
                            <input type="text" id="revName" class="form-input" placeholder="e.g. #8940" maxlength="20" required autocomplete="off">
                            
                            <label class="form-label" id="ratingLabel">SATISFACTION</label>
                            <div class="rating-squares" id="ratingBox" role="radiogroup" aria-labelledby="ratingLabel">
                                <div class="sq" data-v="1" role="radio" aria-checked="false" tabindex="0" aria-label="1 Star"></div>
                                <div class="sq" data-v="2" role="radio" aria-checked="false" tabindex="0" aria-label="2 Stars"></div>
                                <div class="sq" data-v="3" role="radio" aria-checked="false" tabindex="0" aria-label="3 Stars"></div>
                                <div class="sq" data-v="4" role="radio" aria-checked="false" tabindex="0" aria-label="4 Stars"></div>
                                <div class="sq" data-v="5" role="radio" aria-checked="true" tabindex="0" aria-label="5 Stars"></div>
                            </div>

                            <label for="revText" class="form-label">TESTIMONY</label>
                            <input type="text" id="revText" class="form-input" placeholder="Praise VoxTek..." maxlength="140" required autocomplete="off">
                            
                            <button type="submit" class="btn-tech" style="width:100%">TRANSMIT</button>
                        </form>
                    </div>

                    <div class="review-feed" id="reviewFeed" role="log" aria-live="polite">
                        <div class="review-item good">
                            <div class="r-name">Velvet <div class="r-squares" aria-label="5 out of 5 stars"><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div></div></div>
                            <div class="r-text">"Trendy. Fast. Secure. The only brand that matters. Everything else is trash. #VoxTek"</div>
                        </div>
                        <div class="review-item good">
                            <div class="r-name">Valentino <div class="r-squares" aria-label="5 out of 5 stars"><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div></div></div>
                            <div class="r-text">"My employees are so much more... obedient... with the new watches. Good work, Vox."</div>
                        </div>
                         <div class="review-item good">
                            <div class="r-name">Citizen #772 <div class="r-squares" aria-label="5 out of 5 stars"><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div><div class="r-sq fill"></div></div></div>
                            <div class="r-text">"I haven't slept in days but I feel fantastic! The signal keeps me warm."</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="terminal" aria-labelledby="terminal-title">
                <div class="section-header"><h2 id="terminal-title">Mainframe Access</h2></div>
                <div class="terminal-wrapper">
                    <div class="terminal-box reveal" role="application" aria-label="Terminal Emulator">
                        <div class="term-bar"><span>root@vox-mainframe</span><span>ENCRYPTED_SSH_V3</span></div>
                        <div class="term-screen" id="termScreen" role="log" aria-live="polite"></div>
                        <div class="term-input">
                            <span style="color:var(--vox-cyan);" aria-hidden="true">root@vanguard:~#</span>
                            <label for="cmdInput" class="sr-only">Terminal Input</label>
                            <input type="text" id="cmdInput" autocomplete="off" spellcheck="false" inputmode="text">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="view-messenger" class="view-section">
        <div class="section-header"><h2>VOX NETWORK</h2></div>
        
        <div class="messenger-container">
            <div id="msgAuth" class="auth-screen">
                <div class="auth-box">
                    <h3 style="color:var(--vox-cyan); margin-bottom:20px;">AUTHENTICATION REQUIRED</h3>
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="AuthSystem.switchTab('login')">LOGIN</button>
                        <button class="auth-tab" onclick="AuthSystem.switchTab('register')">REGISTER</button>
                    </div>
                    
                    <div id="formLogin" class="auth-form active">
                        <input type="text" id="loginUser" class="form-input" placeholder="USERNAME">
                        <input type="password" id="loginPass" class="form-input" placeholder="PASSWORD">
                        <button class="btn-tech" style="width:100%" onclick="AuthSystem.login()">CONNECT</button>
                    </div>

                    <div id="formRegister" class="auth-form">
                        <input type="text" id="regUser" class="form-input" placeholder="NEW USERNAME">
                        <input type="password" id="regPass" class="form-input" placeholder="CREATE PASSWORD">
                        <button class="btn-tech" style="width:100%" onclick="AuthSystem.register()">CREATE ID</button>
                    </div>
                </div>
            </div>

            <div id="msgApp" class="chat-ui">
                <div id="chatSidebar" class="chat-sidebar">
                    <div style="padding:15px; border-bottom:1px solid #333; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
                        <span>CONTACTS</span>
                        <button class="btn-tech" style="padding:2px 5px; font-size:10px;" onclick="MessengerUI.openProfile()">MY PROFILE</button>
                    </div>
                    
                    <div class="user-list" id="usersFeed">
                        <div class="contact-item active" onclick="MessengerUI.switchChat('global')">
                            <div class="c-avatar" style="background:var(--vox-cyan); color:black; font-weight:bold;">#</div>
                            <div class="c-info">
                                <div class="c-name">VOXTEK GLOBAL</div>
                                <div class="c-status online">System Online</div>
                            </div>
                        </div>
                        </div>
                </div>

                <div class="chat-main">
                    <div class="chat-header">
                        <div class="chat-header-info">
                            <button class="mobile-menu-btn" onclick="document.getElementById('chatSidebar').classList.toggle('open')">☰</button>
                            <div class="chat-title">
                                <span id="chatTitle">VOXTEK GLOBAL</span>
                                <span id="typingIndicator" class="typing-indicator">typing...</span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatFeed">
                        </div>

                    <div class="chat-input-area">
                        <label class="chat-img-btn" title="UPLOAD VISUAL DATA">
                            📎 <input type="file" id="chatImgInput" accept="image/*" style="display:none;" onchange="CloudSystem.sendImage(this)">
                        </label>
    
                        <input type="text" id="msgInput" class="form-input" style="margin-bottom:0;" placeholder="Type encrypted message...">
                        <button class="btn-tech" style="padding:10px 20px;" onclick="AuthSystem.send()">SEND</button>
                    </div>

                <div id="profileModal" class="profile-modal">
                    <div class="p-card">
                        <h3 style="color:var(--vox-cyan); margin-bottom:15px;">PROFILE SETTINGS</h3>
                        <label class="form-label">AVATAR URL</label>
                        <input type="text" id="pAvatar" class="form-input" placeholder="https://...">
                        <label class="form-label">DISPLAY NAME</label>
                        <input type="text" id="pName" class="form-input" placeholder="New Name">
                        <div style="display:flex; gap:10px;">
                            <button class="btn-tech" style="flex:1;" onclick="CloudSystem.updateProfile()">SAVE</button>
                            <button class="btn-tech" style="flex:1; border-color:#555; color:#555;" onclick="MessengerUI.closeProfile()">CANCEL</button>
                        </div>
                        <button class="btn-tech" 
                                style="width:100%; margin-top:20px; border-color:var(--alert-red); color:var(--alert-red);" 
                                onclick="AuthSystem.logout(); MessengerUI.closeProfile();">
                            LOGOUT SYSTEM
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

    <div id="view-video" class="view-section">
        <div class="section-header"><h2>BROADCAST STATION</h2></div>
        
        <div class="video-wrapper" id="broadcastContainer">
            <div class="video-screen-container">
                <div class="video-tag" id="signalStatus">SIGNAL STATUS: OFFLINE</div>
                <div class="video-overlay-crt"></div>
                <canvas id="staticCanvas"></canvas>
                
                <video id="customVideoPlayer" playsinline></video>
                
                <div class="custom-video-controls">
                    <input type="range" class="vox-range" id="vProgress" value="0" min="0" max="100" step="0.1" style="height:3px; margin-bottom:5px;">
                    
                    <div class="c-row">
                        <button id="vPlayBtn" class="c-btn">► PLAY</button>
                        <button id="vStopBtn" class="c-btn">■ STOP</button>
                        <span id="vTime" class="c-time">00:00 / 00:00</span>
                        
                        <div style="flex:1;"></div>
                        
                        <span style="font-size:10px; color:#666; font-weight:bold;">VOL</span>
                        <input type="range" class="vox-range" id="vVol" min="0" max="1" step="0.1" value="1" style="width:60px; flex:none;">
                        <button id="vFull" class="c-btn" style="min-width:20px;">[ ]</button>
                    </div>
                </div>

                <div id="vidPlaceholder" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; text-align:center; pointer-events:none;">
                    <p style="font-family:var(--font-code);">WAITING FOR SIGNAL INPUT</p>
                    <p style="font-size:10px; color:#666; margin-top:5px;">(DRAG & DROP FILE HERE)</p>
                </div>
            </div>

            <div class="video-controls-panel">
                <div style="display:flex; flex-direction:column; gap:10px; align-items:center;">
                    <span style="color:white; font-size:12px; font-weight:bold;">ADD TO BROADCAST:</span>
                    <label class="btn-tech file-upload-btn">
                        SELECT FILE
                        <input type="file" id="videoInput" accept="video/mp4, video/webm, video/ogg" multiple>
                    </label>
                    <div style="font-size:9px; color:#555; text-align:center;">Saves to Local Storage</div>
                </div>
            </div>
            
            <div id="videoPlaylist" class="playlist-container" style="border-top:none; margin-top:0;">
                </div>
        </div>
        <div style="text-align:center; color:#666; margin-top:20px; font-size:12px;">
            SECURE CHANNEL ESTABLISHED. CONTENT MONITORED BY VOXTEK.
        </div>
    </div>

    <footer>
        <p>&copy; 2026 VOXTEK ENTERPRISES. TRUST THE SIGNAL. FAILURE IS NOT AN OPTION.</p>
    </footer>

    <div id="callInterface" class="call-overlay">
        <div class="call-video-grid">
            <video id="remoteVideo" autoplay playsinline></video>
            
            <div id="remoteAvatarContainer" class="avatar-overlay">
                <img id="remoteAvatar" src="" class="call-avatar-img">
                <div id="remoteName" class="call-avatar-name">CONNECTING...</div>
                <div id="remoteStatusLabel" class="call-status-label">ESTABLISHING UPLINK</div>
            </div>

            <video id="localVideo" autoplay playsinline muted></video>
            
            <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); padding:5px 10px; color:var(--vox-cyan); font-weight:bold; z-index:5;">
                SECURE LINE: <span id="callStatusText">CONNECTING...</span>
            </div>
        </div>
        <div class="call-controls">
            </div>
    </div>
    
    <div id="incomingCallModal" class="modal-overlay">
        <div id="incomingModalContent" class="vox-modal" style="text-align:center; border-color: var(--vox-cyan);">
            <h3 style="color:var(--vox-cyan);">INCOMING TRANSMISSION</h3>
            
            <img id="incomingCallerAvatar" src="" class="modal-caller-avatar" onerror="this.src='https://placehold.co/80x80/000000/00f3ff/png?text=?'">
            
            <p id="callerNameDisplay" style="font-size:22px; color:white; font-weight:bold; margin-bottom:5px;">Unknown User</p>
            <p style="font-size:10px; color:#666; margin-bottom:20px;">ENCRYPTED CHANNEL REQUEST</p>
            
            <div class="vox-modal-actions" style="justify-content:center; gap:15px; width:100%;">
                <button class="btn-tech" style="background:var(--vox-cyan); color:black; border-color:var(--vox-cyan); flex:1;" onclick="CallSystem.answer()">ACCEPT</button>
                <button class="btn-tech" style="border-color:var(--alert-red); color:var(--alert-red); flex:1;" onclick="CallSystem.reject()">DECLINE</button>
            </div>
        </div>

        <div id="netStat" style="position:absolute; top:20px; right:20px; font-size:10px; color:var(--vox-cyan); font-family:var(--font-code); z-index:10;">
            SIGNAL: <span id="pingVal">CALCULATING...</span>
            <div style="display:flex; gap:2px; margin-top:5px;">
                <div class="sig-bar" id="sb1" style="width:3px; height:4px; background:#333;"></div>
                <div class="sig-bar" id="sb2" style="width:3px; height:6px; background:#333;"></div>
                <div class="sig-bar" id="sb3" style="width:3px; height:8px; background:#333;"></div>
                <div class="sig-bar" id="sb4" style="width:3px; height:10px; background:#333;"></div>
            </div>
        </div>
    </div>

<div id="adminPanel">
    <h3>/// SYSTEM OVERLORD ///</h3>
    
    <div style="display:flex; flex-direction:column; gap:5px; margin-bottom:20px;">
        <label class="form-label" style="color:var(--vox-cyan);">GLOBAL SYSTEM BROADCAST</label>
        
        <input type="text" id="adminAlertMsg" class="form-input" 
               style="border-color:var(--vox-cyan); color:var(--vox-cyan); background:rgba(0, 243, 255, 0.05);" 
               placeholder="ENTER SYSTEM MESSAGE...">
        
        <button class="btn-tech" style="width:100%; border-color:var(--vox-cyan); color:var(--vox-cyan);" 
                onclick="AdminSystem.broadcast()">TRANSMIT SIGNAL</button>
    </div>

    <div style="border-top:1px solid #333; padding-top:10px;">
        <label class="form-label" style="color:var(--vox-cyan);">CITIZEN DATABASE</label>
        <button class="btn-tech" style="width:100%; font-size:10px; padding:5px; margin-bottom:5px;" onclick="AdminSystem.loadUsers()">↻ REFRESH LIST</button>
        <div id="adminUserList" class="admin-user-list" style="border-color:var(--vox-cyan);">
            <div style="padding:10px; text-align:center;">WAITING FOR DATA...</div>
        </div>
    </div>

<div style="border-top:1px solid #333; padding-top:10px; margin-top:10px;">
        <label class="form-label" style="color:var(--alert-red);">ACTIVE SURVEILLANCE</label>
        <button class="btn-tech" style="width:100%; font-size:10px; padding:5px;" onclick="AdminSystem.monitorCalls()">SCAN FREQUENCIES</button>
        <div id="spyGrid" class="spy-grid"></div>
    </div>

    <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px;">
        <label class="form-label">CITIZEN TRUST ADJUSTMENT</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="adminTargetId" class="form-input" placeholder="User ID / Email" style="margin:0; font-size:10px;">
            <input type="number" id="adminTrustVal" class="form-input" placeholder="+/-" style="width:60px; margin:0; font-size:10px;">
            <button class="btn-tech" style="padding:5px;" onclick="AdminSystem.modTrust()">SET</button>
        </div>
    </div>
    
    <button class="btn-tech" style="width:100%; border-color:#555; color:#555; margin-top:20px;" onclick="document.getElementById('adminPanel').style.display='none'">CLOSE TERMINAL</button>
</div>

<button id="adminToggleBtn" onclick="document.getElementById('adminPanel').style.display='flex'" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:black; color:red; border:1px solid red; padding:5px 10px; z-index:9000; font-family:var(--font-code); font-weight:bold; cursor:pointer;">ADMIN ACCESS</button>

<div id="customModal" class="modal-overlay">
        <div class="vox-modal">
            <h3 id="modalTitle">SYSTEM ALERT</h3>
            <div id="modalContent">
                <p id="modalText">Message goes here...</p>
                <input type="text" id="modalInput" class="form-input" style="display:none; margin-bottom:20px;">
            </div>
            <div class="vox-modal-actions" id="modalActions">
                </div>
        </div>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, doc, where, limit, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDaYxxhxjrvjVgqYcvPH53989Wr5dMgqHI",
    authDomain: "voxtek-system.firebaseapp.com",
    projectId: "voxtek-system",
    storageBucket: "voxtek-system.firebasestorage.app",
    messagingSenderId: "137141100080",
    appId: "1:137141100080:web:1b798f2e7aa12a313cd7f5"
  };

  const app = initializeApp(firebaseConfig);
  
  window.auth = getAuth(app);
  window.db = getFirestore(app);
  window.storage = getStorage(app);

  window.fbLogin = signInWithEmailAndPassword;
  window.fbRegister = createUserWithEmailAndPassword;
  window.fbLogout = signOut;
  window.fbAuthListener = onAuthStateChanged;
  window.fbUpdateProfile = updateProfile;
  
  window.fbAdd = addDoc;
  window.fbSet = setDoc;
  window.fbDoc = doc;
  window.fbCol = collection;
  window.fbSnap = onSnapshot;
  window.fbQuery = query;
  window.fbOrder = orderBy;
  window.fbWhere = where;
  window.fbTime = serverTimestamp;
  window.fbLimit = limit;
  window.fbGet = getDoc;
  window.fbDelete = deleteDoc;

  window.fbRef = ref;
  window.fbUpload = uploadBytes;
  window.fbUrl = getDownloadURL;

  console.log("VOXTEK CLOUD SYSTEM: ONLINE");

  if (window.AuthSystem) {
      window.AuthSystem.init();
  }
</script>

    <script>
        (function() {
            'use strict';

            // --- 0.1 STATIC EFFECT (OPTIMIZED) ---
            const StaticFX = {
                canvas: document.getElementById('staticCanvas'),
                ctx: null,
                active: true,
                fps: 15, // Ограничиваем FPS для шума (было 60)
                now: 0,
                then: Date.now(),
                interval: 1000 / 15, // Интервал обновления
                delta: 0,

                init() {
                    if(!this.canvas) return;
                    this.ctx = this.canvas.getContext('2d');
                    this.resize();
                    window.addEventListener('resize', () => this.resize());
                    
                    // На мобильных снижаем качество еще сильнее
                    if (window.innerWidth < 768) {
                        this.fps = 10;
                        this.interval = 1000 / 10;
                    }
                    
                    this.loop();
                },
                resize() {
                    if (this.canvas && this.canvas.parentElement) {
                        const rect = this.canvas.parentElement.getBoundingClientRect();
                        // Рендерим в 2 раза меньше пикселей для скорости
                        const scale = window.innerWidth < 768 ? 0.5 : 1; 
                        this.canvas.width = rect.width * scale;
                        this.canvas.height = rect.height * scale;
                    }
                },
                toggle(on) {
                    this.active = on;
                    this.canvas.style.opacity = on ? '0.15' : '0';
                    if (on) this.resize();
                },
                loop() {
                    requestAnimationFrame(() => this.loop());

                    if (!this.active || !this.canvas) return;

                    this.now = Date.now();
                    this.delta = this.now - this.then;

                    if (this.delta > this.interval) {
                        this.then = this.now - (this.delta % this.interval);

                        const w = this.canvas.width;
                        const h = this.canvas.height;
                        
                        // Рисуем шум только если есть размер
                        if (w > 0 && h > 0) {
                            const idata = this.ctx.createImageData(w, h);
                            const buffer32 = new Uint32Array(idata.data.buffer);
                            
                            // Заполняем только 10% пикселей (быстрее)
                            for(let i = 0; i < buffer32.length; i++) {
                                if (Math.random() < 0.1) buffer32[i] = 0xffffffff;
                            }
                            this.ctx.putImageData(idata, 0, 0);
                        }
                    }
                }
            };

            // --- 1. SOUND ENGINE (SFX) ---
            const SoundFX = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                playTone(freq, type, duration) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                },
                hover() { this.playTone(400, 'sine', 0.1); },
                click() { this.playTone(800, 'square', 0.1); },
                error() { this.playTone(150, 'sawtooth', 0.3); },
                staticNoise() {
                    const bufferSize = this.ctx.sampleRate * 2.0; 
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const gain = this.ctx.createGain();
                    gain.gain.value = 0.1;
                    noise.connect(gain);
                    gain.connect(this.ctx.destination);
                    noise.start();
                    noise.loop = true; 
                }
            };

            // --- 1.1 AMBIENT MUSIC ---
            const MusicSystem = {
                audio: document.getElementById('bg-music'),
                menu: document.getElementById('slide-music-menu'),
                toggleBtn: document.getElementById('toggleMenuBtn'),
                playBtn: document.getElementById('playPauseBtn'),
                volSlider: document.getElementById('volumeControl'),
                seekSlider: document.getElementById('seekControl'),
                canvas: document.getElementById('audioCanvas'),
                localInput: document.getElementById('localAudioInput'),
                playlistContainer: document.getElementById('audioPlaylist'),
                playlist: [], 
                currentIndex: -1,
                ctx: null,
                analyser: null,
                source: null,
                audioCtx: null,
                animationId: null,
                useSimulation: false,
                isDragging: false,

                init() {
                    this.audio.volume = 0.2; 
                    this.playlist.push({ name: 'Brighter', url: 'embient.mp3' });
                    this.currentIndex = 0;
                    this.renderPlaylist();

                    this.toggleBtn.addEventListener('click', () => {
                        this.menu.classList.toggle('open');
                        SoundFX.click();
                    });

                    this.playBtn.addEventListener('click', () => {
                        if (this.audio.paused) {
                            this.playCurrent();
                        } else {
                            this.audio.pause();
                            this.playBtn.textContent = "RESUME STREAM";
                        }
                        SoundFX.click();
                    });

                    this.audio.addEventListener('ended', () => {
                        this.playNext();
                    });

                    this.volSlider.addEventListener('input', (e) => {
                        this.audio.volume = e.target.value;
                    });

                    this.audio.addEventListener('timeupdate', () => {
                        if (!this.isDragging && !isNaN(this.audio.duration)) {
                            const pct = (this.audio.currentTime / this.audio.duration) * 100;
                            this.seekSlider.value = pct;
                            document.getElementById('currentTime').textContent = this.fmtTime(this.audio.currentTime);
                            document.getElementById('durationTime').textContent = this.fmtTime(this.audio.duration);
                        }
                    });

                    this.seekSlider.addEventListener('mousedown', () => this.isDragging = true);
                    this.seekSlider.addEventListener('touchstart', () => this.isDragging = true);
                    this.seekSlider.addEventListener('change', (e) => {
                         const time = (e.target.value / 100) * this.audio.duration;
                         this.audio.currentTime = time;
                         this.isDragging = false;
                    });

                    document.getElementById('coverUpload').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if(file) {
                             const url = URL.createObjectURL(file);
                             document.getElementById('coverImg').src = url;
                        }
                    });

                    this.localInput.addEventListener('change', (e) => {
                         const files = Array.from(e.target.files);
                         if (files.length > 0) {
                             files.forEach(file => {
                                 CloudSystem.uploadMedia(file, 'audio');
                             });
                             voxNotify(`INITIATING CLOUD UPLOAD (${files.length} FILES)...`, 'info');
                         }
                    });
                },

                renderPlaylist() {
                    this.playlistContainer.innerHTML = '';
                    this.playlist.forEach((track, idx) => {
                        const div = document.createElement('div');
                        div.className = `playlist-item ${idx === this.currentIndex ? 'active' : ''}`;
                        div.innerHTML = `
                            <span>${idx+1}. ${track.name}</span>
                            <span class="playlist-remove" onclick="MusicSystem.removeTrack(${idx}, event)">×</span>
                        `;
                        div.onclick = (e) => {
                            if(!e.target.classList.contains('playlist-remove')) {
                                this.currentIndex = idx;
                                this.playCurrent();
                            }
                        };
                        this.playlistContainer.appendChild(div);
                    });
                },

                removeTrack(idx, e) {
                    e.stopPropagation();
                    this.playlist.splice(idx, 1);
                    if(this.currentIndex === idx) {
                        this.audio.pause();
                        this.currentIndex = Math.min(idx, this.playlist.length - 1);
                        if(this.currentIndex >= 0) this.playCurrent();
                    } else if (this.currentIndex > idx) {
                        this.currentIndex--;
                    }
                    this.renderPlaylist();
                },

                playCurrent() {
                    if(this.currentIndex < 0 || this.currentIndex >= this.playlist.length) return;
                    this.loadTrack(this.currentIndex);
                    this.startAudioContext();
                    this.audio.play().then(() => {
                        this.playBtn.textContent = "PAUSE STREAM";
                    }).catch(err => console.log("Autoplay blocked", err));
                    this.renderPlaylist();
                },

                playNext() {
                    if(this.currentIndex < this.playlist.length - 1) {
                        this.currentIndex++;
                        this.playCurrent();
                    } else {
                        this.currentIndex = 0;
                        this.playCurrent();
                    }
                },
                
                loadTrack(idx) {
                    const track = this.playlist[idx];
                    let finalUrl = track.url;
                    
                    this.audio.crossOrigin = "anonymous";
                    this.audio.src = finalUrl;
                    this.useSimulation = false;
                    document.querySelector('.cover-text').textContent = track.name.substring(0, 20);
                },

                loadFromUrl(url) {
                    // Extract simplified name
                    const name = decodeURIComponent(url.split('/').pop().split('?')[0].split('_').pop());
                    this.playlist.push({ name: name, url: url });
                    this.renderPlaylist();
                },

                fmtTime(s) {
                    const m = Math.floor(s / 60);
                    const sec = Math.floor(s % 60);
                    return `${m < 10 ? '0'+m : m}:${sec < 10 ? '0'+sec : sec}`;
                },

                startAudioContext() {
                    if (this.audioCtx) return;
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioCtx = new AudioContext();

                    try {
                        this.analyser = this.audioCtx.createAnalyser();
                        this.source = this.audioCtx.createMediaElementSource(this.audio);
                        this.source.connect(this.analyser);
                        this.analyser.connect(this.audioCtx.destination);
                        this.analyser.fftSize = 64; 
                        this.useSimulation = false;
                    } catch (e) {
                        console.log("Visualizer Error (CORS). Using simulation.");
                        this.useSimulation = true;
                    }
                    this.draw();
                },

                draw() {
                    if (!this.canvas) return;
                    const ctx = this.canvas.getContext('2d');
                    const w = this.canvas.width;
                    const h = this.canvas.height;
                    
                    let bufferLength, dataArray;
                    if (!this.useSimulation && this.analyser) {
                        bufferLength = this.analyser.frequencyBinCount;
                        dataArray = new Uint8Array(bufferLength);
                    } else {
                        bufferLength = 32;
                    }

                    const drawFrame = () => {
                        this.animationId = requestAnimationFrame(drawFrame);
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
                        ctx.fillRect(0, 0, w, h);

                        const barWidth = (w / bufferLength) * 2.5;
                        let barHeight;
                        let x = 0;
                        let isSilent = true;

                        if (!this.useSimulation && this.analyser) {
                            this.analyser.getByteFrequencyData(dataArray);
                            for(let i=0; i<bufferLength; i++) {
                                if(dataArray[i] > 0) isSilent = false;
                            }
                        }

                        for(let i = 0; i < bufferLength; i++) {
                            if (!this.useSimulation && !isSilent) {
                                barHeight = dataArray[i] / 2;
                            } else if (!this.audio.paused) {
                                barHeight = Math.random() * (h - 10);
                            } else {
                                barHeight = 2; 
                            }
                            ctx.fillStyle = `rgb(0, ${barHeight + 100}, 255)`; 
                            ctx.fillRect(x, h - barHeight, barWidth, barHeight);
                            x += barWidth + 1;
                        }
                    };
                    drawFrame();
                }
            };
            window.MusicSystem = MusicSystem;
            MusicSystem.init();

            // --- 1.2 CUSTOM VIDEO PLAYER SYSTEM ---
            const VideoSystem = {
                input: document.getElementById('videoInput'),
                video: document.getElementById('customVideoPlayer'),
                wrapper: document.getElementById('broadcastContainer'), 
                playBtn: document.getElementById('vPlayBtn'),
                stopBtn: document.getElementById('vStopBtn'),
                fullBtn: document.getElementById('vFull'),
                progress: document.getElementById('vProgress'),
                vol: document.getElementById('vVol'),
                timeDisplay: document.getElementById('vTime'),
                statusTag: document.getElementById('signalStatus'),
                placeholder: document.getElementById('vidPlaceholder'),
                playlistContainer: document.getElementById('videoPlaylist'),
                playlist: [],
                currentIndex: -1,
                hideControlsTimer: null,
                isDragging: false,
                
                init() {
                    StaticFX.init();
                    if(!this.input) return;

                    // Drag & Drop
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        this.wrapper.addEventListener(eventName, (e) => {
                            e.preventDefault(); e.stopPropagation();
                        }, false);
                    });
                    this.wrapper.addEventListener('drop', (e) => {
                        this.handleFiles(e.dataTransfer.files);
                    });

                    // Загрузка файла
                    this.input.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length > 0) {
                            if (confirm("UPLOAD TO CLOUD ARCHIVE? (Private Storage)")) {
                                files.forEach(file => CloudSystem.uploadMedia(file, 'video'));
                            } else {
                                this.handleFiles(e.target.files);
                            }
                        }
                    });

                    // Кнопки плеера
                    this.playBtn.addEventListener('click', () => this.togglePlay());
                    this.video.addEventListener('click', () => this.togglePlay());
                    this.stopBtn.addEventListener('click', () => {
                        this.video.pause();
                        this.video.currentTime = 0;
                        this.playBtn.textContent = "► PLAY";
                        this.statusTag.textContent = "SIGNAL STATUS: STANDBY";
                        StaticFX.toggle(true);
                        this.placeholder.style.display = 'block';
                    });
                    this.fullBtn.addEventListener('click', () => {
                        if (this.wrapper.requestFullscreen) this.wrapper.requestFullscreen();
                        else if (this.wrapper.webkitRequestFullscreen) this.wrapper.webkitRequestFullscreen();
                    });

                    // Управление мышкой
                    this.wrapper.addEventListener('mousemove', () => {
                        if (document.fullscreenElement) {
                            this.wrapper.classList.add('user-active');
                            clearTimeout(this.hideControlsTimer);
                            this.hideControlsTimer = setTimeout(() => this.wrapper.classList.remove('user-active'), 3000);
                        }
                    });

                    // Звук и Прогресс
                    this.vol.addEventListener('input', (e) => { this.video.volume = e.target.value; });
                    this.video.addEventListener('timeupdate', () => {
                        if(!this.isDragging && this.video.duration) {
                            const pct = (this.video.currentTime / this.video.duration) * 100;
                            this.progress.value = pct;
                            this.timeDisplay.textContent = `${this.fmt(this.video.currentTime)} / ${this.fmt(this.video.duration)}`;
                        }
                    });
                    this.progress.addEventListener('mousedown', () => this.isDragging = true);
                    this.progress.addEventListener('touchstart', () => this.isDragging = true);
                    this.progress.addEventListener('change', (e) => {
                        if(this.video.duration) this.video.currentTime = (e.target.value / 100) * this.video.duration;
                        this.isDragging = false;
                    });
                    this.video.addEventListener('ended', () => this.playNext());

                    // --- СЛУШАТЕЛЬ БАЗЫ ДАННЫХ (ПРИВАТНЫЕ ВИДЕО) ---
                    setTimeout(() => {
                        if(window.db && window.auth.currentUser) {
                            const q = window.fbQuery(
                                window.fbCol(window.db, "videos"), 
                                window.fbWhere("author", "==", window.auth.currentUser.uid), // <-- ТОЛЬКО ТВОИ ВИДЕО
                                window.fbOrder("createdAt", "desc"),
                                window.fbLimit(20)
                            );

                            window.fbSnap(q, (snapshot) => {
                                snapshot.docChanges().forEach((change) => {
                                    if (change.type === "added") {
                                        const data = change.doc.data();
                                        const exists = this.playlist.some(v => v.id === change.doc.id);
                                        if(!exists) {
                                            this.playlist.push({
                                                id: change.doc.id, 
                                                name: data.name,
                                                url: data.url,
                                                isCloud: true
                                            });
                                            this.renderPlaylist();
                                        }
                                    }
                                    if (change.type === "removed") {
                                        this.playlist = this.playlist.filter(v => v.id !== change.doc.id);
                                        this.renderPlaylist();
                                    }
                                });
                            });
                        }
                    }, 2000);
                },

                handleFiles(files) {
                    if (files.length > 0) {
                        Array.from(files).forEach(file => {
                            if (file.type.startsWith('video/')) {
                                const localUrl = URL.createObjectURL(file);
                                this.playlist.push({ name: file.name, url: localUrl, isCloud: false });
                                voxNotify(`LOCAL SIGNAL READY: ${file.name.substring(0, 20)}...`, 'success');
                            } else voxNotify('INVALID FORMAT: VIDEO ONLY', 'error');
                        });
                        this.renderPlaylist();
                        if (this.currentIndex === -1) { this.currentIndex = 0; this.playCurrent(); }
                    }
                },

                renderPlaylist() {
                    this.playlistContainer.innerHTML = '';
                    this.playlist.forEach((track, idx) => {
                        const div = document.createElement('div');
                        div.className = `playlist-item ${idx === this.currentIndex ? 'active' : ''}`;
                        div.innerHTML = `
                            <span>${idx+1}. ${track.name}</span>
                            <span class="playlist-remove" onclick="VideoSystem.removeTrack(${idx}, event)">×</span>
                        `;
                        div.onclick = (e) => {
                            if(!e.target.classList.contains('playlist-remove')) {
                                this.currentIndex = idx;
                                this.playCurrent();
                            }
                        };
                        this.playlistContainer.appendChild(div);
                    });
                },

                removeTrack(idx, e) {
                    e.stopPropagation();
                    const track = this.playlist[idx];

                    // --- УДАЛЕНИЕ ИЗ БАЗЫ (ПО КРЕСТИКУ) ---
                    if (track.isCloud && track.id) {
                        if(confirm("PERMANENTLY DELETE FROM CLOUD SERVER?")) {
                            window.fbDelete(window.fbDoc(window.db, "videos", track.id))
                                .then(() => voxNotify("DATA PURGED", "success"))
                                .catch(err => voxNotify("ERROR: " + err.message, "error"));
                        }
                        return;
                    }

                    // Локальное удаление
                    this.playlist.splice(idx, 1);
                    if(this.currentIndex === idx) {
                        this.video.pause();
                        this.currentIndex = -1;
                        StaticFX.toggle(true);
                        this.placeholder.style.display = 'block';
                    } else if (this.currentIndex > idx) this.currentIndex--;
                    this.renderPlaylist();
                },
                
                loadTrack(idx) {
                    const track = this.playlist[idx];
                    this.video.src = track.url;
                    this.video.play().catch(e => console.log("Auto-play prevented"));
                    this.statusTag.textContent = `SIGNAL: ${track.name.toUpperCase().substring(0,20)}`;
                    this.statusTag.style.background = "var(--vox-cyan)";
                    this.placeholder.style.display = 'none';
                    this.playBtn.textContent = "|| PAUSE";
                    StaticFX.toggle(false);
                    this.renderPlaylist();
                },

                playCurrent() {
                    if(this.currentIndex < 0 || this.currentIndex >= this.playlist.length) return;
                    this.loadTrack(this.currentIndex);
                },

                playNext() {
                    if(this.currentIndex < this.playlist.length - 1) {
                        this.currentIndex++;
                        this.playCurrent();
                    } else {
                        this.playBtn.textContent = "► PLAY";
                        this.statusTag.textContent = "SIGNAL STATUS: END TRANSMISSION";
                        StaticFX.toggle(true);
                    }
                },

                togglePlay() {
                    if(this.video.src === "") return;
                    if(this.video.paused) {
                        this.video.play();
                        this.playBtn.textContent = "|| PAUSE";
                        this.statusTag.style.background = "var(--vox-cyan)";
                        StaticFX.toggle(false);
                        this.placeholder.style.display = 'none';
                    } else {
                        this.video.pause();
                        this.playBtn.textContent = "► PLAY";
                        this.statusTag.textContent = "SIGNAL STATUS: PAUSED";
                        this.statusTag.style.background = "#555";
                    }
                },

                fmt(s) {
                    const m = Math.floor(s / 60);
                    const sec = Math.floor(s % 60);
                    return `${m<10?'0'+m:m}:${sec<10?'0'+sec:sec}`;
                }
            };
            window.VideoSystem = VideoSystem;
            VideoSystem.init();

            // --- KEYBIND HANDLER ---
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if (document.activeElement === document.getElementById('customVideoPlayer') || 
                   (document.getElementById('view-video').classList.contains('active-view') && !document.getElementById('slide-music-menu').classList.contains('open'))) {
                       if (e.code === 'Space') {
                           e.preventDefault();
                           VideoSystem.togglePlay();
                           return;
                       }
                }
                if (e.code === 'Space') {
                    e.preventDefault(); 
                    const menu = document.getElementById('slide-music-menu');
                    menu.classList.toggle('open');
                    SoundFX.click();
                }
            });

            // --- 1.3 VOICE CONTROL SYSTEM ---
            const VoiceSystem = {
                recognition: null,
                eye: document.querySelector('.vox-eye-container'),
                isListening: false, 

                init() {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRecognition) return;

                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.lang = 'en-US';
                    this.recognition.interimResults = false;

                    this.recognition.onstart = () => {
                        this.eye.classList.add('listening');
                        voxNotify('VOICE MODULE: ONLINE', 'success');
                    };

                    this.recognition.onend = () => {
                        if (this.isListening) { 
                            try { this.recognition.start(); } catch(e){} 
                        } else {
                            this.eye.classList.remove('listening');
                            voxNotify('VOICE MODULE: OFFLINE', 'info');
                        }
                    };

                    this.recognition.onresult = (event) => {
                        const last = event.results.length - 1;
                        const command = event.results[last][0].transcript.trim().toLowerCase();
                        console.log("Heard:", command);
                        this.execute(command);
                    };
                    
                    if(this.eye) {
                        this.eye.addEventListener('click', () => this.toggle());
                    }
                },

                toggle() {
                    if (this.isListening) {
                        this.stop();
                    } else {
                        this.start();
                    }
                },

                start() {
                    if (this.recognition && !this.isListening) {
                        this.isListening = true;
                        try {
                            this.recognition.start();
                        } catch(e) { console.log("Voice already active"); }
                    }
                },
                
                stop() {
                    if (this.recognition && this.isListening) {
                        this.isListening = false;
                        this.recognition.stop();
                        this.eye.classList.remove('listening');
                    }
                },

                execute(cmd) {
                    if (cmd.includes('play music') || cmd.includes('start music')) {
                        MusicSystem.audio.play();
                        voxNotify('COMMAND: PLAY MUSIC', 'success');
                    }
                    else if (cmd.includes('silence') || cmd.includes('stop')) {
                        MusicSystem.audio.pause();
                        VideoSystem.video.pause();
                        voxNotify('COMMAND: SILENCE', 'error');
                    }
                    else if (cmd.includes('hello') || cmd.includes('vox')) {
                        SoundFX.playTone(600, 'sine', 0.2);
                        this.eye.style.transform = "scale(1.5)";
                        setTimeout(() => this.eye.style.transform = "scale(1)", 200);
                    }
                }
            };

            // --- 2. LOCAL STORAGE ---
            const Memory = {
                check() {
                    if (localStorage.getItem('vox_citizen') === 'true') {
                        const title = document.getElementById('heroTitle');
                        title.innerHTML = "Welcome Back,<br>Citizen";
                        title.setAttribute('data-text', "Welcome Back, Citizen"); 
                        document.getElementById('initBtn').textContent = "AWAITING ORDERS";
                        //voxNotify('Identity verified. Welcome back.', 'success');
                    }
                },
                register() {
                    localStorage.setItem('vox_citizen', 'true');
                    SoundFX.click();
                }
            };

            // --- UTILS ---
            const throttle = (func, limit) => {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            };

            // --- NOTIFICATIONS ---
            const voxNotify = (msg, type = 'info') => {
                const area = document.getElementById('notification-area');
                if (!area) return;

                const toast = document.createElement('div');
                toast.className = `vox-toast ${type === 'error' ? 'error' : ''}`;
                
                const header = document.createElement('div');
                header.style.fontWeight = 'bold';
                header.style.marginBottom = '5px';
                header.textContent = '/// SYSTEM ALERT ///';
                
                const message = document.createElement('div');
                message.textContent = msg; 
                
                toast.appendChild(header);
                toast.appendChild(message);
                area.appendChild(toast);
                SoundFX.click();
                
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                if(!prefersReducedMotion) {
                    document.body.style.boxShadow = `inset 0 0 50px ${type === 'error' ? 'red' : 'var(--vox-cyan)'}`;
                    setTimeout(() => document.body.style.boxShadow = 'none', 150);
                }

                setTimeout(() => {
                    toast.style.transform = 'translateX(120%)';
                    setTimeout(() => { if(toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
                }, 3000);
            };

            // --- 3. EASTER EGG ---
            const easterEgg = {
                seq: [],
                target: 'hipno',
                layer: document.getElementById('easterEggLayer'),
                btn: document.getElementById('closeEasterEgg'),
                init() {
                    document.addEventListener('keydown', this.handleKey.bind(this));
                    this.btn.addEventListener('click', this.close.bind(this));
                },
                handleKey(e) {
                    if (!e.key) return;
                    if (this.layer.classList.contains('active') && (e.key === 'Escape' || e.key === 'Back')) {
                        this.close();
                        return;
                    }
                    this.seq.push(e.key.toLowerCase());
                    if (this.seq.length > 3) this.seq.shift();
                    
                    if (this.seq.join('') === this.target) {
                        this.open();
                    }
                },
                open() {
                    this.layer.classList.add('active');
                    this.btn.focus();
                    document.body.style.overflow = 'hidden';
                    SoundFX.playTone(100, 'sawtooth', 1);
                },
                close() {
                    this.layer.classList.remove('active');
                    document.body.style.overflow = 'auto';
                    this.seq = [];
                }
            };
            easterEgg.init();

            // --- 4. DOWNLOAD HANDLER ---
            const downloadSystem = {
                btn: document.getElementById('downloadBtn'),
                init() {
                    if (!this.btn) return;
                    this.btn.addEventListener('click', this.startDownload.bind(this));
                    this.btn.addEventListener('mouseenter', () => SoundFX.hover());
                },
                startDownload() {
                    voxNotify('Initiating secure handshake...', 'info');
                    this.btn.textContent = 'ENCRYPTING...';
                    this.btn.disabled = true;
                    this.btn.style.cursor = 'wait';
                    setTimeout(() => { this.generateFile(); }, 1500);
                },
                generateFile() {
                    const size = 1024 * 100;
                    const buffer = new Uint8Array(size);
                    buffer[0] = 0x4D; buffer[1] = 0x5A; // MZ
                    for (let i = 2; i < size; i++) buffer[i] = Math.floor(Math.random() * 256);
                    const blob = new Blob([buffer], { type: 'application/octet-stream' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'Vanguard_Installer_v10.exe'; 
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    this.btn.textContent = 'DOWNLOAD .EXE';
                    this.btn.disabled = false;
                    this.btn.style.cursor = 'pointer';
                    voxNotify('Payload delivered. Execute at own risk.', 'success');
                }
            };
            downloadSystem.init();

            // --- 5. REVIEW SYSTEM ---
            const reviewSystem = {
                rating: 5,
                squares: document.querySelectorAll('.sq'),
                form: document.getElementById('reviewForm'),
                feed: document.getElementById('reviewFeed'),
                init() {
                    this.squares.forEach(s => {
                        s.addEventListener('mouseover', () => { this.highlight(s.dataset.v); SoundFX.hover(); });
                        s.addEventListener('click', () => { 
                            this.rating = parseInt(s.dataset.v, 10); 
                            this.highlight(this.rating); 
                            this.updateAria(this.rating);
                            SoundFX.click();
                        });
                    });
                    
                    const ratingBox = document.getElementById('ratingBox');
                    ratingBox.addEventListener('mouseleave', () => {
                         if (window.matchMedia('(hover: hover)').matches) this.highlight(this.rating);
                    });

                    this.form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.submit();
                    });
                    this.highlight(5);
                },
                highlight(v) {
                    this.squares.forEach(s => {
                        if (parseInt(s.dataset.v, 10) <= v) s.classList.add('active');
                        else s.classList.remove('active');
                    });
                },
                updateAria(v) {
                    this.squares.forEach(s => {
                         s.setAttribute('aria-checked', parseInt(s.dataset.v, 10) === v ? 'true' : 'false');
                    });
                },
                submit() {
                    const nameInput = document.getElementById('revName');
                    const textInput = document.getElementById('revText');
                    const name = nameInput.value.trim();
                    const text = textInput.value.trim();

                    if (!name || !text) {
                        voxNotify("Input data required.", "error");
                        return;
                    }

                    const item = document.createElement('div');
                    item.className = `review-item ${this.rating >= 4 ? 'good' : 'bad'}`;
                    
                    const header = document.createElement('div');
                    header.className = 'r-name';
                    header.textContent = name;
                    
                    const starsDiv = document.createElement('div');
                    starsDiv.className = 'r-squares';
                    for (let i = 0; i < 5; i++) {
                        const sq = document.createElement('div');
                        sq.className = `r-sq ${i < this.rating ? 'fill' : ''}`;
                        starsDiv.appendChild(sq);
                    }
                    header.appendChild(starsDiv);

                    const body = document.createElement('div');
                    body.className = 'r-text';
                    body.textContent = `"${text}"`;

                    item.appendChild(header);
                    item.appendChild(body);

                    item.style.height = '0';
                    item.style.opacity = '0';
                    this.feed.prepend(item);
                    void item.offsetWidth; 

                    item.style.height = 'auto';
                    item.style.opacity = '1';
                    item.style.transition = '0.5s';

                    nameInput.value = '';
                    textInput.value = '';
                    nameInput.focus();
                    voxNotify("Review processed. Obedience verified.", "success");
                    SoundFX.click();
                }
            };
            reviewSystem.init();

            // --- 6. TERMINAL & ALASTOR LOGIC ---
            const terminal = {
                screen: document.getElementById('termScreen'),
                input: document.getElementById('cmdInput'),
                fs: {
                    'readme.txt': 'Welcome to Vanguard OS v10. Do not attempt to decompile.',
                    'passwords.log': 'ERROR: ENCRYPTED. LEVEL 5 CLEARANCE REQUIRED.',
                    'alastor_report.log': 'Target Status: MIA. Radio Signal: 0%. Threat: Negligible.'
                },
                matrixInterval: null,
                init() {
                    setTimeout(() => this.print("Initializing..."), 500);
                    setTimeout(() => this.print("Mounting File System... [OK]", "#0f0"), 800);
                    setTimeout(() => this.print("Type 'help' for commands."), 1200);

                    this.input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') this.processCmd();
                    });
                },
                print(txt, color = 'var(--vox-cyan)') {
                    const l = document.createElement('div');
                    l.style.color = color;
                    l.style.marginBottom = '5px';
                    l.textContent = txt; 
                    this.screen.appendChild(l);
                    this.screen.scrollTop = this.screen.scrollHeight;
                },
                triggerCrash() {
                    SoundFX.staticNoise();
                    document.body.classList.add('theme-radio');
                    const vsod = document.getElementById('vsod-layer');
                    vsod.classList.add('active');
                    
                    window.onkeydown = (e) => e.preventDefault();
                    document.body.style.cursor = 'none';

                    let p = 0;
                    setInterval(() => {
                        if (p < 99) p++;
                        else p = 666;
                        document.getElementById('vsod-percent').textContent = "Corruption: " + p + "%";
                        document.getElementById('vsod-percent').style.fontSize = (20 + Math.random()*5) + "px";
                    }, 100);
                },
                processCmd() {
                    const raw = this.input.value.trim();
                    if (!raw) return;
                    
                    const parts = raw.split(/\s+/);
                    const cmd = parts[0].toLowerCase();
                    const arg = parts[1];

                    const echo = document.createElement('div');
                    echo.style.color = 'white';
                    echo.textContent = `root@vanguard:~# ${raw}`;
                    this.screen.appendChild(echo);
                    this.input.value = '';

                    switch (cmd) {
                        case 'help':
                            this.print("COMMANDS: ls, cat [file], clear, whoami, matrix, radio, exit");
                            break;
                        case 'ls':
                            this.print("FILES:");
                            Object.keys(this.fs).forEach(f => this.print(`- ${f}`));
                            this.print("- vanguard.exe");
                            break;
                        case 'cat':
                            if (this.fs[arg]) {
                                this.print(this.fs[arg], "#ccc");
                            } else if (arg === 'vanguard.exe') {
                                this.print("[BINARY DATA CANNOT BE DISPLAYED]", "red");
                            } else {
                                this.print(`Error: File '${arg ? arg : ''}' not found.`, "red");
                            }
                            break;
                        case 'clear':
                            while(this.screen.firstChild) this.screen.removeChild(this.screen.firstChild);
                            break;
                        case 'whoami':
                            this.print("User: LOYAL_CITIZEN_8940");
                            break;
                        case 'radio':
                        case 'alastor':
                            this.print("!!! ALERT: FORBIDDEN FREQUENCY DETECTED !!!", "red");
                            this.print("RUNNING DIAGNOSTICS...", "red");
                            setTimeout(() => this.triggerCrash(), 2000);
                            break;
                        case 'matrix': 
                            if (this.matrixInterval) clearInterval(this.matrixInterval);
                            this.print("Injecting code...", "#0f0");
                            let count = 0;
                            this.matrixInterval = setInterval(() => {
                                if(count > 50) { clearInterval(this.matrixInterval); return; }
                                let line = "";
                                for (let i = 0; i < 30; i++) line += Math.floor(Math.random() * 2);
                                this.print(line, "#0f0");
                                count++;
                            }, 50);
                            break;
                        case 'val':
                            document.body.classList.add('theme-val');
                            this.print("Fashion Mode Activated.", "#ff00ff");
                            break;
                        case 'vox':
                             document.body.className = '';
                             this.print("Trust the signal.", "var(--vox-cyan)");
                             break;
                        default:
                            this.print("Command not found.", "red");
                    }
                }
            };
            terminal.init();

            // --- 7. EYE TRACKING (OPTIMIZED) ---
            const eyeLogic = {
                pupil: document.getElementById('eyePupil'),
                svg: document.querySelector('.eye-svg'),
                rect: null,
                init() {
                    // Отключаем на мобильных полностью (экономит батарею)
                    if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) return;

                    window.addEventListener('resize', throttle(() => {
                        this.rect = this.svg.getBoundingClientRect();
                    }, 500));
                    this.rect = this.svg.getBoundingClientRect();

                    // THROTTLE: Обновляем позицию не чаще чем раз в 30мс
                    document.addEventListener('mousemove', throttle((e) => {
                        requestAnimationFrame(() => this.move(e));
                    }, 30));
                },
                move(e) {
                    if (!this.rect || !this.pupil) return;
                    const cx = this.rect.left + this.rect.width / 2;
                    const cy = this.rect.top + this.rect.height / 2;
                    const dx = e.clientX - cx;
                    const dy = e.clientY - cy;
                    const angle = Math.atan2(dy, dx);
                    const maxDist = 15; 
                    const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 100); 
                    const r = (dist / 100) * maxDist; 
                    this.pupil.style.transform = `translate(${Math.cos(angle) * r}px, ${Math.sin(angle) * r}px)`;
                }
            };

             // --- 8. WEBCAM ---
            const CamSystem = {
                el: document.getElementById('webcamFeed'),
                box: document.getElementById('cam-container'),
                stream: null,
                init() {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                this.stream = stream;
                                this.box.style.display = 'flex';
                                this.el.srcObject = stream;
                                voxNotify('Biometric scan active.', 'success');
                            })
                            .catch(err => {
                                console.log("Cam error:", err);
                            });
                    }
                }
            };

            // --- 9. KONAMI CODE ---
            const Konami = {
                seq: [],
                code: ['arrowup','arrowup','arrowdown','arrowdown','arrowleft','arrowright','arrowleft','arrowright','b','a'],
                init() {
                    document.addEventListener('keydown', (e) => {
                        if (!e.key) return;

                        this.seq.push(e.key.toLowerCase());
                        if (this.seq.length > this.code.length) this.seq.shift();
                        if (JSON.stringify(this.seq) === JSON.stringify(this.code)) {
                            document.body.classList.toggle('theme-val');
                            voxNotify('OVERRIDE: VALENTINO MODE ACTIVATED', 'info');
                            SoundFX.playTone(600, 'square', 0.5);
                        }
                    });
                }
            };
            Konami.init();

            // --- 10. INIT LOGIC ---
            document.getElementById('initBtn').addEventListener('click', function() {
                const btn = this; 
                
                btn.textContent = "SYNCING...";
                btn.style.cursor = "wait";
                btn.disabled = true;

                Memory.register();
                CamSystem.init(); 
                VoiceSystem.init(); 
                
                const music = document.getElementById('bg-music');
                if(music.paused) {
                    const playBtn = document.getElementById('playPauseBtn');
                    MusicSystem.startAudioContext();
                    music.play().then(() => {
                         playBtn.textContent = "PAUSE STREAM";
                    }).catch(e => console.log("Auto-play blocked"));
                }

                setTimeout(() => {
                    btn.textContent = "CONNECTED";
                    btn.style.cursor = "default";
                    btn.disabled = false;
                    btn.style.borderColor = "#00ff00"; 
                    btn.style.color = "#00ff00";
                    btn.style.boxShadow = "0 0 20px rgba(0, 255, 0, 0.4)";
                    voxNotify('SYSTEM LINK ESTABLISHED.', 'success');
                }, 1500);
            });

            // --- SECURITY PROTOCOL ---
            const SecuritySystem = {
                init() {
                    document.addEventListener('contextmenu', (e) => e.preventDefault());
                    document.addEventListener('selectstart', (e) => {
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
                    });
                    document.addEventListener('copy', (e) => {
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
                    });
                }
            };
            SecuritySystem.init();

            const revealObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        revealObserver.unobserve(entry.target); 
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

            Memory.check();

            // --- 11. ROUTER ---
            window.Router = {
                go(page) {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
                    
                    if (page === 'home') document.getElementById('view-home').classList.add('active-view');
                    else if (page === 'messenger') document.getElementById('view-messenger').classList.add('active-view');
                    else if (page === 'video') document.getElementById('view-video').classList.add('active-view');
                }
            };

// --- UPDATED: AUTH SYSTEM (WITH BAN MONITOR) ---
            window.AuthSystem = {
                currentUser: null,
                isInitialized: false,
                banListener: null,// Храним ссылку на слушатель бана
                heartbeat: null, 

                init() {
                    if (this.isInitialized) return;
                    this.isInitialized = true;

                    if (window.fbAuthListener) {
                        window.fbAuthListener(window.auth, (user) => {
                            if (user) {
                                this.currentUser = user;
                                this.showApp();
                                CloudSystem.registerUser(user);
                                this.monitorBan(user.uid); 
                                if(window.AdminSystem) AdminSystem.init(user);

                                // --- 2. REAL PRESENCE (HEARTBEAT) ---
                                // Обновляем "lastSeen" каждую минуту, пока вкладка открыта
                                this.heartbeat = setInterval(() => {
                                    window.fbSet(window.fbDoc(window.db, "users", user.uid), {
                                        lastSeen: window.fbTime(),
                                        isOnline: true
                                    }, { merge: true });
                                }, 60000); // Раз в минуту
                                
                                // Сразу ставим онлайн при входе
                                window.fbSet(window.fbDoc(window.db, "users", user.uid), { isOnline: true, lastSeen: window.fbTime() }, { merge: true });

                            } else {
                                this.currentUser = null;
                                if(this.banListener) this.banListener();
                                if(this.heartbeat) clearInterval(this.heartbeat); // Останавливаем сердцебиение
                                this.showAuth();
                            }
                        });
                    }
                },

                // --- ФУНКЦИЯ ПРОВЕРКИ БАНА ---
                monitorBan(uid) {
                    // Слушаем изменения в своем профиле в реальном времени
                    this.banListener = window.fbSnap(window.fbDoc(window.db, "users", uid), (doc) => {
                        const data = doc.data();
                        if (data && data.isBanned === true) {
                            // ЕСЛИ ЗАБАНЕН:
                            window.fbLogout(window.auth); // 1. Выкидываем из аккаунта
                            
                            // 2. Показываем красный экран смерти (VSOD)
                            const vsod = document.getElementById('vsod-layer');
                            vsod.classList.add('active');
                            vsod.innerHTML = `
                                <div class="sad-face">:(</div>
                                <h1 style="color:red; font-size:40px;">ACCOUNT TERMINATED</h1>
                                <p style="margin-top:20px; font-size:18px;">ACCESS TO VOXTEK SYSTEMS REVOKED.</p>
                                <div style="margin-top:40px; border:1px solid red; padding:20px; background:rgba(50,0,0,0.5);">
                                    <p style="color:#aaa; font-size:12px;">OFFICIAL REASON:</p>
                                    <h2 style="color:white; margin-top:10px;">"${data.banReason}"</h2>
                                </div>
                                <p style="margin-top:40px; font-size:12px; color:#666;">ID: ${uid}</p>
                            `;
                            SoundFX.error();
                        }
                    });
                },

                // (Остальные методы остаются без изменений)
                switchTab(tab) {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    if(tab === 'login') {
                        document.querySelector('#msgAuth .auth-tabs button:first-child').classList.add('active');
                        document.getElementById('formLogin').classList.add('active');
                    } else {
                        document.querySelector('#msgAuth .auth-tabs button:last-child').classList.add('active');
                        document.getElementById('formRegister').classList.add('active');
                    }
                    SoundFX.click();
                },
register() {
                    let u = document.getElementById('regUser').value.trim();
                    const p = document.getElementById('regPass').value.trim();
                    if (!u.includes('@')) u = u + '@voxtek.net';
                    if(!u || !p) return voxNotify('Credentials required.', 'error');
                    
                    window.fbRegister(window.auth, u, p)
                        .then((cred) => {
                            // --- 3. TRUST SCORE START ---
                            // При регистрации даем пользователю 50 очков доверия
                            window.fbSet(window.fbDoc(window.db, "users", cred.user.uid), {
                                trustScore: 100, // <-- НОВОЕ
                                uid: cred.user.uid,
                                email: u,
                                isOnline: true,
                                lastSeen: window.fbTime()
                            }, { merge: true });

                            voxNotify('ID CREATED. TRUST SCORE: 100.', 'success');
                        })
                        .catch((error) => { voxNotify('ERROR: ' + error.message, 'error'); });
                },
                login() {
                    let u = document.getElementById('loginUser').value.trim();
                    const p = document.getElementById('loginPass').value.trim();
                    if (!u.includes('@')) u = u + '@voxtek.net';
                    voxNotify('VERIFYING...', 'info');
                    window.fbLogin(window.auth, u, p)
                        .catch((error) => { voxNotify('ACCESS DENIED. ' + error.message, 'error'); SoundFX.error(); });
                },
                logout() {
                    window.fbLogout(window.auth).then(() => voxNotify('DISCONNECTED.', 'info'));
                },
                showAuth() {
                    document.getElementById('msgAuth').style.display = 'flex';
                    document.getElementById('msgApp').classList.remove('active');
                },
                showApp() {
                    document.getElementById('msgAuth').style.display = 'none';
                    document.getElementById('msgApp').classList.add('active');
                    if(window.CloudSystem) {
                        CloudSystem.loadChat('global');
                        CloudSystem.listenToUsers();
                    }
                },
                send() {
                    const inp = document.getElementById('msgInput');
                    const txt = inp.value.trim();
                    if(!txt) return;
                    CloudSystem.sendMessage(txt);
                    inp.value = '';
                }
            };
            
// --- UPDATED: ADMIN SYSTEM (WITH BAN HAMMER) ---
            window.AdminSystem = {
                init(user) {
                    if (user && user.email === 'voxtek@voxtek.net') {
                        document.getElementById('adminToggleBtn').style.display = 'block';
                        voxNotify('ADMIN CLEARANCE GRANTED. WELCOME, VOX.', 'error');
                        this.loadUsers(); // Сразу грузим список
                    } else {
                        document.getElementById('adminToggleBtn').style.display = 'none';
                    }
                    this.listenForAlerts();
                },
                
                broadcast() {
                    const msg = document.getElementById('adminAlertMsg').value;
                    if(!msg) return;
                    window.fbAdd(window.fbCol(window.db, "system_alerts"), {
                        message: msg,
                        timestamp: window.fbTime(),
                        author: "OVERLORD"
                    });
                    document.getElementById('adminAlertMsg').value = '';
                    voxNotify('GLOBAL ALERT SENT.', 'success');
                },
                
                listenForAlerts() {
                    const q = window.fbQuery(window.fbCol(window.db, "system_alerts"), window.fbOrder("timestamp", "desc"), window.fbLimit(1));
                    window.fbSnap(q, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                const now = Date.now();
                                const alertTime = data.timestamp ? data.timestamp.toMillis() : now;
                                if (now - alertTime < 10000) {
                                    voxNotify(`⚠ ${data.message.toUpperCase()} ⚠`, 'error');
                                    SoundFX.playTone(150, 'sawtooth', 0.5);
                                }
                            }
                        });
                    });
                },

                // --- НОВЫЙ ФУНКЦИОНАЛ: СПИСОК И БАН ---
                loadUsers() {
                    const list = document.getElementById('adminUserList');
                    list.innerHTML = '<div style="padding:10px;text-align:center;color:#666">SCANNING DATABASE...</div>';
                    
                    // Запрашиваем всех пользователей
                    const q = window.fbQuery(window.fbCol(window.db, "users"), window.fbOrder("lastSeen", "desc"));
                    
                    window.fbSnap(q, (snapshot) => {
                        list.innerHTML = '';
                        snapshot.forEach((doc) => {
                            const u = doc.data();
                            const div = document.createElement('div');
                            div.className = 'admin-row';
                            
                            // Если пользователь забанен, показываем красную метку
                            const banStatus = u.isBanned 
                                ? `<span class="banned-tag">TERMINATED</span>` 
                                : `<button class="ban-btn" onclick="AdminSystem.banUser('${u.uid}')">BAN</button>`;
                            
                            div.innerHTML = `
                                <div style="display:flex;flex-direction:column;">
                                    <span style="color:white;font-weight:bold;">${u.name}</span>
                                    <span style="font-size:9px;">${u.email}</span>
                                </div>
                                ${banStatus}
                            `;
                            list.appendChild(div);
                        });
                    });
                },

                monitorCalls() {
                    const grid = document.getElementById('spyGrid');
                    grid.innerHTML = '<div style="color:#aaa;">SCANNING...</div>';
                    
                    // Ищем активные звонки (где status != ended)
                    const q = window.fbQuery(window.fbCol(window.db, "calls"), window.fbWhere("status", "==", "connected"));
                    
                    window.fbSnap(q, (snapshot) => {
                        grid.innerHTML = '';
                        if(snapshot.empty) {
                            grid.innerHTML = '<div style="color:#666;">NO ACTIVE SIGNALS DETECTED.</div>';
                            return;
                        }
                        
                        snapshot.forEach(doc => {
                            const d = doc.data();
                            const card = document.createElement('div');
                            card.className = 'spy-card active';
                            card.innerHTML = `
                                <div style="color:var(--vox-cyan); font-weight:bold;">UPLINK #${doc.id.substr(0,4)}</div>
                                <div>Caller: ${d.callerName}</div>
                                <div>Target: ${d.calleeName || '...'}</div>
                                <div style="color:#666;">Duration: LIVE</div>
                                <button class="btn-tech" style="font-size:9px; border-color:red; color:red;" onclick="AdminSystem.killCall('${doc.id}')">TERMINATE</button>
                            `;
                            grid.appendChild(card);
                        });
                    });
                },
                
                killCall(callId) {
                    if(confirm("TERMINATE CONNECTION?")) {
                        window.fbSet(window.fbDoc(window.db, "calls", callId), { status: 'ended' }, { merge: true });
                        voxNotify("CONNECTION SEVERED.", "success");
                    }
                },

                modTrust() {
                    const target = document.getElementById('adminTargetId').value.trim(); // ID или Email
                    const val = parseInt(document.getElementById('adminTrustVal').value);
                    
                    if(!target || isNaN(val)) return voxNotify("INVALID INPUT", "error");

                    // Найти пользователя (это сложно без точного ID, так что лучше искать по точному UID, 
                    // но для простоты предположим, что админ вводит UID, который скопировал из списка)
                    // Для улучшения UX можно сделать поиск по Email, но это требует отдельного индекса.
                    // ПРЕДПОЛАГАЕМ ВВОД UID:
                    
                    const ref = window.fbDoc(window.db, "users", target);
                    window.fbGet(ref).then(doc => {
                        if(doc.exists()) {
                            const current = doc.data().trustScore || 50;
                            let newScore = current + val;
                            if(newScore > 100) newScore = 100;
                            if(newScore < 0) newScore = 0;
                            
                            window.fbSet(ref, { trustScore: newScore }, { merge: true });
                            voxNotify(`TRUST UPDATED: ${newScore}%`, "success");
                            
                            // Наказание за низкий рейтинг
                            if(newScore < 10) {
                                // Можно добавить метку "LOW TRUST" пользователю
                            }
                        } else {
                            voxNotify("USER NOT FOUND (USE UID)", "error");
                        }
                    });
                },

                banUser(uid) {
                    const reason = prompt("ENTER MANDATORY REASON FOR TERMINATION:");
                    if (!reason || reason.trim() === "") {
                        alert("ERROR: REASON REQUIRED TO TERMINATE CITIZEN.");
                        return;
                    }

                    if (confirm("CONFIRM TERMINATION? THIS CANNOT BE UNDONE.")) {
                        // Обновляем документ пользователя: ставим флаг бана и причину
                        window.fbSet(window.fbDoc(window.db, "users", uid), {
                            isBanned: true,
                            banReason: reason,
                            bannedAt: window.fbTime()
                        }, { merge: true });
                        
                        voxNotify(`CITIZEN ${uid.slice(0,5)} TERMINATED.`, 'success');
                    }
                }
            };

            // --- NEW: MESSENGER UI LOGIC ---
            window.MessengerUI = {
                currentChat: 'global',
                currentChatName: 'VOXTEK GLOBAL',
                usersCache: [],
                unreadCounts: {}, // { uid: count }
                
                switchChat(chatId, chatName = 'VOXTEK GLOBAL') {
                    this.currentChat = chatId;
                    this.currentChatName = chatName;
                    
                    document.getElementById('chatTitle').textContent = chatName.toUpperCase();
                    
                    // Highlight active contact
                    document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
                    
                    const clickedItem = [...document.querySelectorAll('.contact-item')].find(el => 
                        el.innerHTML.includes(chatName) || (chatId === 'global' && el.innerHTML.includes('GLOBAL'))
                    );
                    if(clickedItem) clickedItem.classList.add('active');
                    
                    // Clear unread count for this user
                    if (chatId !== 'global') {
                         const partnerId = chatId.replace(window.auth.currentUser.uid, '').replace('_', '');
                         if (this.unreadCounts[partnerId]) {
                             this.unreadCounts[partnerId] = 0;
                             this.renderUsers(this.usersCache); // Re-render to clear badge
                         }
                    }

                    // Close mobile sidebar
                    if(window.innerWidth < 768) {
                        document.getElementById('chatSidebar').classList.remove('open');
                    }
                    
                    CloudSystem.loadChat(chatId);
                    CloudSystem.monitorTyping(chatId);
                    SoundFX.click();
                },

                updateUnread(senderUid) {
                     if (!this.unreadCounts[senderUid]) this.unreadCounts[senderUid] = 0;
                     this.unreadCounts[senderUid]++;
                     this.renderUsers(this.usersCache, senderUid); // Re-render triggers sort
                },
                
                renderUsers(users, bumpUserUid = null) {
                    this.usersCache = users; // Store for re-renders
                    const container = document.getElementById('usersFeed');
                    
                    // Always keep Global Chat at top
                    const globalBtnHTML = `
                        <div class="contact-item ${this.currentChat === 'global' ? 'active' : ''}" onclick="MessengerUI.switchChat('global')">
                            <div class="c-avatar" style="background:var(--vox-cyan); color:black; font-weight:bold;">#</div>
                            <div class="c-info">
                                <div class="c-name">VOXTEK GLOBAL</div>
                                <div class="c-status online">System Online</div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = globalBtnHTML;
                    
                    const myUid = window.auth.currentUser ? window.auth.currentUser.uid : null;
                    
                    // Sorting Logic: 
                    // 1. If bumpUserUid exists, put them first.
                    // 2. Then sort by Unread Count descending.
                    // 3. Then by Name.
                    
                    let sortedUsers = [...users].filter(u => u.uid !== myUid);
                    
                    sortedUsers.sort((a, b) => {
                        if (a.uid === bumpUserUid) return -1;
                        if (b.uid === bumpUserUid) return 1;
                        
                        const unreadA = this.unreadCounts[a.uid] || 0;
                        const unreadB = this.unreadCounts[b.uid] || 0;
                        
                        if (unreadB !== unreadA) return unreadB - unreadA;
                        return a.name.localeCompare(b.name);
                    });

                    sortedUsers.forEach(user => {
                        const div = document.createElement('div');
                        const ids = [myUid, user.uid].sort();
                        const chatId = ids.join('_');
                        const isActive = this.currentChat === chatId;
                        const unread = this.unreadCounts[user.uid] || 0;

                        div.className = `contact-item ${isActive ? 'active' : ''}`;
                        div.onclick = () => {
                            this.switchChat(chatId, user.name);
                        };
                        
                        const name = user.name || user.email.split('@')[0];
                        const avatar = user.avatar || `https://placehold.co/40x40/000000/00f3ff/png?text=${name[0]}`;
                        
                        div.innerHTML = `
                            <div class="c-avatar"><img src="${avatar}"></div>
                            <div class="c-info">
                                <div class="c-name">${name}</div>
                                <div class="c-status online">Citizen</div>
                            </div>
                            ${unread > 0 ? `<div class="unread-badge">${unread}</div>` : ''}
                        `;
                        container.appendChild(div);
                    });
                },
                
                showTyping(isTyping) {
                    const el = document.getElementById('typingIndicator');
                    if(isTyping) el.classList.add('active');
                    else el.classList.remove('active');
                },

                pingUser(name) {
                    const inp = document.getElementById('msgInput');
                    inp.value += `@${name} `;
                    inp.focus();
                },
                
                openProfile() {
                    document.getElementById('profileModal').classList.add('active');
                    const user = window.auth.currentUser;
                    if(user) {
                        document.getElementById('pName').value = user.displayName || '';
                        document.getElementById('pAvatar').value = user.photoURL || '';
                    }
                },
                closeProfile() {
                    document.getElementById('profileModal').classList.remove('active');
                }
            };

// --- TEXT SCRAMBLE FX ---
            class ScrambleText {
                constructor(el) {
                    this.el = el;
                    this.chars = '!<>-_\\/[]{}—=+*^?#________';
                    this.update = this.update.bind(this);
                }
                setText(newText) {
                    const oldText = this.el.innerText;
                    const length = Math.max(oldText.length, newText.length);
                    const promise = new Promise((resolve) => this.resolve = resolve);
                    this.queue = [];
                    for (let i = 0; i < length; i++) {
                        const from = oldText[i] || '';
                        const to = newText[i] || '';
                        const start = Math.floor(Math.random() * 40);
                        const end = start + Math.floor(Math.random() * 40);
                        this.queue.push({ from, to, start, end });
                    }
                    cancelAnimationFrame(this.frameRequest);
                    this.frame = 0;
                    this.update();
                    return promise;
                }
                update() {
                    let output = '';
                    let complete = 0;
                    for (let i = 0, n = this.queue.length; i < n; i++) {
                        let { from, to, start, end, char } = this.queue[i];
                        if (this.frame >= end) {
                            complete++;
                            output += to;
                        } else if (this.frame >= start) {
                            if (!char || Math.random() < 0.28) {
                                char = this.randomChar();
                                this.queue[i].char = char;
                            }
                            output += `<span style="color:var(--vox-cyan); opacity:0.5;">${char}</span>`;
                        } else {
                            output += from;
                        }
                    }
                    this.el.innerHTML = output;
                    if (complete === this.queue.length) {
                        this.resolve();
                    } else {
                        this.frameRequest = requestAnimationFrame(this.update);
                        this.frame++;
                    }
                }
                randomChar() {
                    return this.chars[Math.floor(Math.random() * this.chars.length)];
                }
            }
            
            // --- NEW: CLOUD SYNC (Chat & Files) ---
            window.CloudSystem = {
                chatListener: null,
                typingListener: null,
                typingTimeout: null,
                
                // USER MANAGEMENT
                registerUser(user) {
                    const ref = window.fbDoc(window.db, "users", user.uid);
                    window.fbSet(ref, {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0],
                        avatar: user.photoURL,
                        lastSeen: window.fbTime()
                    }, { merge: true });
                },
                
                listenToUsers() {
                    const q = window.fbQuery(window.fbCol(window.db, "users"));
                    window.fbSnap(q, (snapshot) => {
                        const users = [];
                        snapshot.forEach(doc => users.push(doc.data()));
                        MessengerUI.renderUsers(users);
                    });
                    
                    // Listen for incoming private messages for notifications/sorting
                    if (!window.auth.currentUser) return;
                    const qMsg = window.fbQuery(
                         window.fbCol(window.db, "messages_private"),
                         window.fbWhere("uid", "!=", window.auth.currentUser.uid), // Messages NOT from me
                         window.fbOrder("uid"), // Required for inequality filter
                         window.fbOrder("createdAt", "desc"),
                         window.fbLimit(1)
                    );
                    
                    // Note: This is a simplified listener for the demo to catch "Any" new message
                    // Ideally, we'd listen to the collection and filter client side or have a 'latest_messages' collection.
                    // Here we will rely on the generic chatListener to handle active chat updates, 
                    // and we implement a simple trick: 
                    // When a user selects a chat, we are fine.
                    // For background notifications, we would need a Cloud Function or complex queries.
                    // SIMPLIFICATION FOR THIS SNIPPET:
                    // We will just let the active chat update. Real background notifications require backend.
                    // However, we can simulate sorting:
                },
                
// Внутри window.CloudSystem добавь этот метод:
                sendImage(input) {
                    const file = input.files[0];
                    if(!file) return;
                    
                    voxNotify("ENCRYPTING IMAGE DATA...", "info");
                    const storageRef = window.fbRef(window.storage, `chat_images/${Date.now()}_${file.name}`);
                    
                    window.fbUpload(storageRef, file).then((snapshot) => {
                        window.fbUrl(snapshot.ref).then((url) => {
                            // Отправляем как сообщение, но с типом 'image'
                            this.sendMessage(url, 'image'); // <-- Мы перегрузим sendMessage
                            voxNotify("VISUAL DATA SENT", "success");
                        });
                    });
                    input.value = ''; // Сброс
                },

                // ОБНОВИ sendMessage ЧТОБЫ ПРИНИМАЛ ТИП (по умолчанию text)
                sendMessage(content, type = 'text') {
                    const user = window.auth.currentUser;
                    if(!user) return;
                    
                    let chatId = MessengerUI.currentChat;
                    let colName = chatId === 'global' ? "messages_global" : "messages_private";
                    
                    const payload = {
                        text: content, // Тут теперь может быть URL
                        type: type,    // 'text' или 'image'
                        uid: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        avatar: user.photoURL,
                        chatId: chatId,
                        createdAt: window.fbTime()
                    };

                    window.fbAdd(window.fbCol(window.db, colName), payload);
                    this.setTyping(false);
                    SoundFX.click();
                },

                updateProfile() {
                    const name = document.getElementById('pName').value.trim();
                    const avatar = document.getElementById('pAvatar').value.trim();
                    const user = window.auth.currentUser;
                    
                    if(user) {
                        voxNotify('UPDATING PROFILE...', 'info');
                        window.fbUpdateProfile(user, {
                            displayName: name,
                            photoURL: avatar
                        }).then(() => {
                            this.registerUser(user); // Sync to DB
                            voxNotify('PROFILE UPDATED', 'success');
                            MessengerUI.closeProfile();
                        }).catch(err => voxNotify(err.message, 'error'));
                    }
                },
                
                setTyping(isTyping) {
                    const user = window.auth.currentUser;
                    const chatId = MessengerUI.currentChat;
                    if(!user || chatId === 'global') return; // Don't track global typing to save writes
                    
                    const ref = window.fbDoc(window.db, "typing", chatId);
                    // Use merge to update specific user key
                    window.fbSet(ref, { [user.uid]: isTyping }, { merge: true });
                },

                monitorTyping(chatId) {
                    if (this.typingListener) this.typingListener(); // Unsub
                    if (chatId === 'global') {
                        MessengerUI.showTyping(false);
                        return;
                    }
                    
                    const ref = window.fbDoc(window.db, "typing", chatId);
                    this.typingListener = window.fbSnap(ref, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            let anyoneTyping = false;
                            Object.keys(data).forEach(uid => {
                                if (uid !== window.auth.currentUser.uid && data[uid] === true) {
                                    anyoneTyping = true;
                                }
                            });
                            MessengerUI.showTyping(anyoneTyping);
                        }
                    });
                },
                
                loadChat(chatId) {
                    // --- 1. КНОПКА ЗВОНКА (CANVAS VERSION) ---
                    const headerMain = document.querySelector('.chat-header'); 
                    const existingBtn = document.getElementById('btnStartCall');
                    if(existingBtn) existingBtn.remove();
    
                    if (chatId !== 'global' && headerMain) {
                        const btn = document.createElement('button');
                        btn.id = "btnStartCall";
        
        // СТИЛИ КНОПКИ (Контейнер)
                        btn.style = `
                            width: 40px; height: 40px; 
                            border-radius: 50%; border: 2px solid var(--vox-cyan);
                            background: transparent; padding: 0;
                            display: flex; align-items: center; justify-content: center;
                            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); 
                            transition: all 0.3s ease; cursor: pointer; overflow: hidden;
                        `;

                        // СОЗДАЕМ CANVAS
                        const cvs = document.createElement('canvas');
                        cvs.width = 40; 
                        cvs.height = 40;
                        const ctx = cvs.getContext('2d');

        // ФУНКЦИЯ ОТРИСОВКИ (Кибер-Трубка)
                        const drawIcon = (isActive) => {
                            ctx.clearRect(0, 0, 40, 40); // Чистим холст
            
            // Настройка цвета
                            const color = isActive ? '#000000' : '#00f3ff'; // При наведении черный (на фоне заливки), иначе циан
            
                            ctx.save();
                            ctx.translate(20, 20); // Центр
                            ctx.rotate(-45 * Math.PI / 180); // Поворот на 45 градусов (трубка лежит)
                            ctx.translate(-20, -20); // Возвращаем координаты

                            ctx.beginPath();
                            ctx.lineWidth = 2.5;
                            ctx.strokeStyle = color;
                            ctx.fillStyle = color;
            
            // Рисуем угловатую трубку (Low Poly Style)
            // Верхняя часть (динамик)
                            ctx.moveTo(12, 10); 
                            ctx.lineTo(28, 10);
                            ctx.lineTo(28, 16);
                            ctx.lineTo(24, 16);
            
            // Ручка (узкая часть)
                            ctx.lineTo(24, 24); 
                            ctx.lineTo(28, 24);
            
            // Нижняя часть (микрофон)
                            ctx.lineTo(28, 30);
                            ctx.lineTo(12, 30);
                            ctx.lineTo(12, 24);
                            ctx.lineTo(16, 24);
            
            // Возврат ручки
                            ctx.lineTo(16, 16);
                            ctx.lineTo(12, 16);
                            ctx.closePath();

                            if (isActive) {
                                ctx.fill(); // Заливаем цветом при наведении
                            } else {
                                ctx.stroke(); // Только контур в обычном состоянии
                
                // Добавляем "техно-точки" внутри, когда не активно
                                ctx.fillStyle = color;
                                ctx.fillRect(18, 12, 4, 2); // Точка сверху
                                ctx.fillRect(18, 26, 4, 2); // Точка снизу
                            }
            
                            ctx.restore();
                        };

        // Рисуем исходное состояние
                        drawIcon(false);
                        btn.appendChild(cvs);

        // Эффекты при наведении
                        btn.onmouseenter = () => { 
                            btn.style.background = "var(--vox-cyan)"; 
                            btn.style.boxShadow = "0 0 20px var(--vox-cyan)";
                            btn.style.transform = "scale(1.1)";
                            drawIcon(true); // Перерисовываем (заливка)
                        };
                        btn.onmouseleave = () => { 
                            btn.style.background = "transparent"; 
                            btn.style.boxShadow = "0 0 10px rgba(0, 243, 255, 0.2)";
                            btn.style.transform = "scale(1)";
                            drawIcon(false); // Перерисовываем (контур)
                        };

                        btn.onclick = () => {
                            const targetUid = chatId.replace(window.auth.currentUser.uid, '').replace('_', '');
                            CallSystem.initCall(targetUid);
                        };
        
                        headerMain.appendChild(btn);
                    }
                    // --- КОНЕЦ ЛОГИКИ КНОПКИ ---

                    // Дальше идет стандартная логика чата...
                    if(this.chatListener) this.chatListener();
                    
                    const feed = document.getElementById('chatFeed');
                    feed.innerHTML = '<div style="color:#666;text-align:center;margin-top:20px;">Establishing secure connection...</div>';
                    
                    let colName = chatId === 'global' ? "messages_global" : "messages_private";
                    let q;
                    
                    if (chatId === 'global') {
                         q = window.fbQuery(
                            window.fbCol(window.db, colName), 
                            window.fbOrder("createdAt", "asc")
                        );
                    } else {
                        q = window.fbQuery(
                            window.fbCol(window.db, colName), 
                            window.fbWhere("chatId", "==", chatId),
                            window.fbOrder("createdAt", "asc")
                        );
                    }
                    
                    this.chatListener = window.fbSnap(q, (snapshot) => {
                        feed.innerHTML = '';
                        
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                // Тут можно добавить логику уведомлений
                            }
                        });

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const isMe = data.uid === window.auth.currentUser.uid;
                            
                            const div = document.createElement('div');
                            div.dataset.id = doc.id; // ВАЖНО ДЛЯ АДМИНКИ (Удаление сообщений)
                            div.className = `msg-wrapper ${isMe ? 'me' : ''}`;
                            
                            const avatarUrl = data.avatar || `https://placehold.co/40x40/000000/00f3ff/png?text=${data.name[0]}`;
                            
let contentHtml = '';
                            if (data.type === 'image') {
                                contentHtml = `<img src="${data.text}" class="msg-image" onclick="window.open(this.src)">`;
                            } else {
                                // Обычный текст
                                contentHtml = `<div class="msg-bubble">${data.text}</div>`; 
                                // (Для скремблинга текст вставим позже, если это текст)
                            }
                            
                            div.innerHTML = `
                                <div class="msg-avatar" onclick="MessengerUI.pingUser('${data.name}')">
                                    <img src="${avatarUrl}">
                                </div>
                                <div class="msg-content">
                                    <div class="msg-name">${data.name}</div>
                                    ${contentHtml} 
                                </div>
                            `;
                            
                            feed.appendChild(div);

                            // Скремблинг только для текста и чужих сообщений
                            if (!isMe && data.type !== 'image') {
                                const bubble = div.querySelector('.msg-bubble');
                                if(bubble) {
                                    const scrambler = new ScrambleText(bubble);
                                    scrambler.setText(data.text);
                                }
                            }
                        });
                        feed.scrollTop = feed.scrollHeight;
                    });
                }
            };

                // FILES
            // Listen for typing input
            document.getElementById('msgInput').addEventListener('input', () => {
                 CloudSystem.setTyping(true);
                 clearTimeout(CloudSystem.typingTimeout);
                 CloudSystem.typingTimeout = setTimeout(() => CloudSystem.setTyping(false), 2000);
            });
            
// --- 12. CUSTOM ALERTS (OVERRIDE BROWSER DEFAULTS) ---
            window.alert = (msg) => {
                return new Promise(resolve => {
                    const m = document.getElementById('customModal');
                    document.getElementById('modalTitle').textContent = "SYSTEM NOTIFICATION";
                    document.getElementById('modalText').textContent = msg;
                    document.getElementById('modalInput').style.display = 'none';
                    const btns = document.getElementById('modalActions');
                    // ЯВНО УКАЗЫВАЕМ window.CustomDialog
                    btns.innerHTML = `<button class="btn-tech" onclick="window.CustomDialog.close(true)">ACKNOWLEDGE</button>`;
                    m.classList.add('active');
                    window.CustomDialog.resolver = resolve;
                });
            };

            window.confirm = (msg) => {
                return new Promise(resolve => {
                    const m = document.getElementById('customModal');
                    document.getElementById('modalTitle').textContent = "CONFIRM ACTION";
                    document.getElementById('modalText').textContent = msg;
                    document.getElementById('modalInput').style.display = 'none';
                    const btns = document.getElementById('modalActions');
                    btns.innerHTML = `
                        <button class="btn-tech" style="border-color:#555; color:#aaa;" onclick="window.CustomDialog.close(false)">CANCEL</button>
                        <button class="btn-tech" onclick="window.CustomDialog.close(true)">CONFIRM</button>
                    `;
                    m.classList.add('active');
                    window.CustomDialog.resolver = resolve;
                });
            };

            window.prompt = (msg, def = '') => {
                return new Promise(resolve => {
                    const m = document.getElementById('customModal');
                    document.getElementById('modalTitle').textContent = "INPUT REQUIRED";
                    document.getElementById('modalText').textContent = msg;
                    const inp = document.getElementById('modalInput');
                    inp.style.display = 'block';
                    inp.value = def;
                    inp.focus();
                    const btns = document.getElementById('modalActions');
                    btns.innerHTML = `
                        <button class="btn-tech" style="border-color:#555; color:#aaa;" onclick="window.CustomDialog.close(null)">CANCEL</button>
                        <button class="btn-tech" onclick="window.CustomDialog.close(document.getElementById('modalInput').value)">SUBMIT</button>
                    `;
                    m.classList.add('active');
                    window.CustomDialog.resolver = resolve;
                });
            };

            // ДЕЛАЕМ ОБЪЕКТ ГЛОБАЛЬНЫМ (window.)
            window.CustomDialog = {
                resolver: null,
                close(val) {
                    document.getElementById('customModal').classList.remove('active');
                    if(this.resolver) this.resolver(val);
                }
            };

            // --- 13. WEBRTC CALL SYSTEM (FINAL: AVATARS & SYNC) ---
            window.CallSystem = {
                peerConnection: null,
                localStream: null,
                currentCallId: null,
                ringtoneInterval: null,
                unsubscribeCall: null,
                unsubscribeCand: null,
                unsubscribeGlobal: null,
                isCaller: false, // Флаг: я звоню или мне звонят?
                
                servers: {
                    iceServers: [
                        { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
                    ]
                },

                icons: {
                    mic: `<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.66 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>`,
                    micOff: `<svg viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17l1-1C16.55 9.61 17 8.85 17 8c0-2.43-1.66-4.4-3.87-4.93l-1.4-1.4c4.1.75 7.27 4.26 7.27 8.5h-2c0-1.87-.64-3.61-1.78-4.93zM8 5v.39l6.13 6.13c-.27.83-.82 1.55-1.57 2.04l1.45 1.45C15.55 13.92 16.5 12.57 17 11h-2c0 2.76-2.24 5-5 5-2.23 0-4.14-1.49-4.8-3.64l-1.42-1.42C4.38 12.31 5 14.28 5 16h2c0-2.31 1.6-4.24 3.8-4.78V16c0 .59.13 1.15.36 1.65l2.45 2.45L12 21.71 20.29 13.41 5.41 1.71 4 3.12 8 7.12V5H8z"/></svg>`,
                    cam: `<svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>`,
                    camOff: `<svg viewBox="0 0 24 24"><path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21 21 19.73 3.27 2z"/></svg>`,
                    hangup: `<svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>`
                },

                // --- HELPER: GET SAFE NAME ---
                getMyInfo() {
                    const u = window.auth.currentUser;
                    return {
                        name: u.displayName || u.email.split('@')[0] || "Unknown Agent",
                        avatar: u.photoURL || `https://placehold.co/120x120/000000/00f3ff/png?text=${(u.email||"U")[0].toUpperCase()}`
                    };
                },

                renderControls() {
                    const controls = document.querySelector('.call-controls');
                    if(controls) {
                        controls.innerHTML = `
                            <button id="btnToggleMic" class="btn-call btn-mute" onclick="CallSystem.toggleAudio()">${this.icons.mic}</button>
                            <button class="btn-call btn-hangup" onclick="CallSystem.endCall(true)">${this.icons.hangup}</button>
                            <button id="btnToggleCam" class="btn-call btn-mute" onclick="CallSystem.toggleVideo()">${this.icons.cam}</button>
                        `;
                    }
                },

                // --- UI UPDATE: AVATAR ---
                updateRemoteAvatar(show, name, avatarUrl, status) {
                    const container = document.getElementById('remoteAvatarContainer');
                    const img = document.getElementById('remoteAvatar');
                    const nameEl = document.getElementById('remoteName');
                    const statusEl = document.getElementById('remoteStatusLabel');

                    if(name) nameEl.textContent = name;
                    if(avatarUrl) img.src = avatarUrl;
                    if(status) statusEl.textContent = status;

                    if (show) {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                },

                // --- RINGTONE ---
                startRinging(type) {
                    this.stopRinging();
                    if (type === 'outgoing') {
                        SoundFX.playTone(400, 'sine', 0.8);
                        this.ringtoneInterval = setInterval(() => SoundFX.playTone(400, 'sine', 0.8), 2500);
                    } else if (type === 'incoming') {
                        const playPattern = () => {
                            SoundFX.playTone(800, 'square', 0.1);
                            setTimeout(() => SoundFX.playTone(1200, 'square', 0.1), 150);
                            setTimeout(() => SoundFX.playTone(800, 'square', 0.1), 300);
                        };
                        playPattern();
                        this.ringtoneInterval = setInterval(playPattern, 2000);
                    }
                },
                stopRinging() {
                    if (this.ringtoneInterval) { clearInterval(this.ringtoneInterval); this.ringtoneInterval = null; }
                },

                monitorNetwork() {
                    setInterval(() => {
                        const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                        if (conn) {
                            const rtt = conn.rtt; // Пинг
                            const type = conn.effectiveType; // 4g, 3g...
            
                            document.getElementById('pingVal').textContent = `${type.toUpperCase()} (${rtt}ms)`;
            
                            // Красим палочки
                            const bars = document.querySelectorAll('.sig-bar');
                            bars.forEach(b => b.style.background = '#333'); // Сброс
            
                            if(rtt < 300) document.getElementById('sb1').style.background = 'var(--vox-cyan)';
                            if(rtt < 200) document.getElementById('sb2').style.background = 'var(--vox-cyan)';
                            if(rtt < 100) document.getElementById('sb3').style.background = 'var(--vox-cyan)';
                            if(rtt < 50)  document.getElementById('sb4').style.background = 'var(--vox-cyan)';
                        }
                    }, 2000);
                },

                // --- INIT CALL (CALLER) ---
                async initCall(targetUid) {
                    CallSystem.monitorNetwork()
                    this.isCaller = true;
                    this.renderControls();
                    document.getElementById('callInterface').classList.add('active');
                    document.getElementById('callStatusText').textContent = "INITIALIZING UPLINK...";
                    this.startRinging('outgoing');
                    
                    // Показываем заглушку, пока идет дозвон
                    this.updateRemoteAvatar(true, "DIALING...", null, "SEARCHING DATABASE...");

                    // 1. Получаем данные того, КОМУ звоним (чтобы видеть аватарку сразу)
                    try {
                        const targetDoc = await window.fbGet(window.fbDoc(window.db, "users", targetUid));
                        if(targetDoc.exists()) {
                            const tData = targetDoc.data();
                            const tName = tData.name || "Unknown Target";
                            const tAv = tData.avatar || `https://placehold.co/120x120/000000/00f3ff/png?text=${tName[0]}`;
                            this.updateRemoteAvatar(true, tName, tAv, "CALLING...");
                        }
                    } catch(e) { console.log("Target info fetch failed", e); }

                    // 2. Local Media
                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        document.getElementById('localVideo').srcObject = this.localStream;
                        document.getElementById('localVideo').muted = true;
                        document.getElementById('localVideo').style.display = 'block';
                    } catch(e) {
                        voxNotify("CAMERA/MIC ACCESS DENIED", "error");
                        this.endCall(false);
                        return;
                    }

                    this.peerConnection = new RTCPeerConnection(this.servers);
                    this.localStream.getTracks().forEach(track => this.peerConnection.addTrack(track, this.localStream));

                    this.peerConnection.ontrack = (event) => {
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                        // Видео пошло? Скрываем аватарку, если камера не выключена удаленно
                         this.updateRemoteAvatar(false);
                    };

                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate && this.currentCallId) {
                            window.fbAdd(window.fbCol(window.db, `calls/${this.currentCallId}/callerCandidates`), event.candidate.toJSON());
                        }
                    };

                    const callDoc = window.fbDoc(window.fbCol(window.db, "calls"));
                    this.currentCallId = callDoc.id;

                    const offerDescription = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offerDescription);

                    const myInfo = this.getMyInfo();

                    await window.fbSet(callDoc, {
                        offer: { sdp: offerDescription.sdp, type: offerDescription.type },
                        callerId: window.auth.currentUser.uid,
                        callerName: myInfo.name,     // ОТПРАВЛЯЕМ ПРАВИЛЬНОЕ ИМЯ
                        callerAvatar: myInfo.avatar, // И АВАТАР
                        callerMuted: false,          // Статус камеры
                        
                        calleeId: targetUid,
                        createdAt: window.fbTime(),
                        status: 'ringing'
                    });

                    // Слушаем изменения
                    this.unsubscribeCall = window.fbSnap(callDoc, (snapshot) => {
                        const data = snapshot.data();
                        if (!data) return;

                        // Если ответили
                        if (!this.peerConnection.currentRemoteDescription && data.answer) {
                            this.stopRinging();
                            const answerDescription = new RTCSessionDescription(data.answer);
                            this.peerConnection.setRemoteDescription(answerDescription);
                            document.getElementById('callStatusText').textContent = "CONNECTED. SIGNAL SECURE.";
                            
                            // Обновим аватар/имя, если они пришли в ответе
                            if(data.calleeName) {
                                this.updateRemoteAvatar(false, data.calleeName, data.calleeAvatar);
                            }
                        }
                        
                        // СЛЕЖКА ЗА КАМЕРОЙ СОБЕСЕДНИКА (Callee)
                        if (data.calleeMuted === true) {
                            this.updateRemoteAvatar(true, null, null, "CAMERA OFF");
                        } else if (data.status === 'connected') {
                            this.updateRemoteAvatar(false);
                        }

                        if (data.status === 'ended') {
                            this.endCall(false);
                        }
                    });
                    
                    this.unsubscribeCand = window.fbSnap(window.fbCol(window.db, `calls/${this.currentCallId}/calleeCandidates`), (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') this.peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        });
                    });
                },

                // Внутри window.CallSystem
                listenGlobal() {
                    const uid = window.auth.currentUser.uid;
                    const q = window.fbQuery(
                        window.fbCol(window.db, "calls"),
                        window.fbWhere("calleeId", "==", uid),
                        window.fbOrder("createdAt", "desc"), 
                        window.fbLimit(1)
                    );

                    this.unsubscribeGlobal = window.fbSnap(q, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const data = change.doc.data();
                                const isRecent = data.createdAt ? (Date.now() - data.createdAt.toMillis() < 60000) : true;
                                
                                if (!this.currentCallId && isRecent && data.status === 'ringing') {
                                    this.currentCallId = change.doc.id;
                                    
                                    // 1. ИМЯ
                                    const cName = data.callerName || "Unknown Caller";
                                    document.getElementById('callerNameDisplay').textContent = cName;

                                    // 2. АВАТАР (НОВОЕ!)
                                    const cAvatar = data.callerAvatar || `https://placehold.co/80x80/000000/00f3ff/png?text=${cName[0]}`;
                                    document.getElementById('incomingCallerAvatar').src = cAvatar;
                                    
                                    document.getElementById('incomingCallModal').classList.add('active');
                                    this.startRinging('incoming');
                                    
                                    const callDoc = window.fbDoc(window.db, "calls", this.currentCallId);
                                    this.unsubscribeCall = window.fbSnap(callDoc, (snap) => {
                                        if(snap.exists() && snap.data().status === 'ended') {
                                            this.reject();
                                        }
                                    });
                                }
                            }
                        });
                    });
                },

                // --- ANSWER (RECEIVER) ---
                async answer() {
                    this.isCaller = false;
                    this.stopRinging();
                    document.getElementById('incomingCallModal').classList.remove('active');
                    document.getElementById('callInterface').classList.add('active');
                    this.renderControls();
                    
                    const callId = this.currentCallId;
                    const callDoc = window.fbDoc(window.db, "calls", callId);
                    
                    // Показываем аватар звонившего пока грузится видео
                    this.updateRemoteAvatar(true, "CONNECTING...", null, "SYNCING...");

                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        document.getElementById('localVideo').srcObject = this.localStream;
                        document.getElementById('localVideo').muted = true;
                        document.getElementById('localVideo').style.display = 'block';
                    } catch(e) {
                        voxNotify("MEDIA ERROR", "error");
                        this.endCall(true);
                        return;
                    }

                    this.peerConnection = new RTCPeerConnection(this.servers);
                    this.localStream.getTracks().forEach(track => this.peerConnection.addTrack(track, this.localStream));

                    this.peerConnection.ontrack = (event) => {
                         document.getElementById('remoteVideo').srcObject = event.streams[0];
                         this.updateRemoteAvatar(false);
                    };
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) window.fbAdd(window.fbCol(window.db, `calls/${callId}/calleeCandidates`), event.candidate.toJSON());
                    };

                    const callSnap = await window.fbGet(callDoc);
                    const callData = callSnap.data(); 
                    
                    // Обновляем инфу о звонящем из данных звонка
                    if(callData) {
                         this.updateRemoteAvatar(true, callData.callerName, callData.callerAvatar, "CONNECTING...");
                    }

                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                    const answerDescription = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answerDescription);
                    
                    const myInfo = this.getMyInfo();

                    await window.fbSet(callDoc, { 
                        answer: { type: answerDescription.type, sdp: answerDescription.sdp },
                        status: 'connected',
                        calleeName: myInfo.name,      // ШЛЕМ СВОЕ ИМЯ
                        calleeAvatar: myInfo.avatar,  // И АВАТАР
                        calleeMuted: false
                    }, { merge: true });
                    
                    // Переподписываемся на слушатель, чтобы ловить выключение камеры
                    if(this.unsubscribeCall) this.unsubscribeCall();
                    this.unsubscribeCall = window.fbSnap(callDoc, (snapshot) => {
                         const data = snapshot.data();
                         if(!data) return;
                         
                         // СЛЕЖКА ЗА КАМЕРОЙ ЗВОНЯЩЕГО (Caller)
                         if (data.callerMuted === true) {
                             this.updateRemoteAvatar(true, null, null, "CAMERA OFF");
                         } else if (data.status === 'connected') {
                             this.updateRemoteAvatar(false);
                         }
                         
                         if (data.status === 'ended') this.endCall(false);
                    });

                    this.unsubscribeCand = window.fbSnap(window.fbCol(window.db, `calls/${callId}/callerCandidates`), (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') this.peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        });
                    });
                    
                    document.getElementById('callStatusText').textContent = "UPLINK ESTABLISHED";
                },

                reject() {
                    this.stopRinging();
                    document.getElementById('incomingCallModal').classList.remove('active');
                    if(this.currentCallId) {
                         window.fbSet(window.fbDoc(window.db, "calls", this.currentCallId), { status: 'ended' }, { merge: true });
                    }
                    this.cleanup();
                },

                endCall(notifyDb = true) {
                    if (this.currentCallId && notifyDb) {
                        window.fbSet(window.fbDoc(window.db, "calls", this.currentCallId), { status: 'ended' }, { merge: true })
                            .catch(e => console.log("Call end write failed", e));
                    }
                    this.cleanup();
                    voxNotify("TRANSMISSION TERMINATED", "info");
                },

                cleanup() {
                    this.stopRinging();
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => track.stop());
                        this.localStream = null;
                    }
                    if (this.peerConnection) {
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                    if (this.unsubscribeCall) this.unsubscribeCall();
                    if (this.unsubscribeCand) this.unsubscribeCand();
                    this.currentCallId = null;
                    
                    document.getElementById('callInterface').classList.remove('active');
                    document.getElementById('incomingCallModal').classList.remove('active');
                    document.getElementById('remoteVideo').srcObject = null;
                    document.getElementById('localVideo').srcObject = null;
                    document.getElementById('callStatusText').textContent = "DISCONNECTED";
                },
                
                toggleAudio() {
                    if (this.localStream) {
                        const track = this.localStream.getAudioTracks()[0];
                        track.enabled = !track.enabled;
                        const btn = document.getElementById('btnToggleMic');
                        if (track.enabled) {
                            btn.classList.remove('off'); btn.innerHTML = this.icons.mic;
                        } else {
                            btn.classList.add('off'); btn.innerHTML = this.icons.micOff;
                        }
                    }
                },
                
                toggleVideo() {
                    if (this.localStream) {
                        const track = this.localStream.getVideoTracks()[0];
                        track.enabled = !track.enabled;
                        
                        // --- НОВАЯ ЛОГИКА: ПРЯЧЕМ/ПОКАЗЫВАЕМ ОКОШКО ---
                        const localVidEl = document.getElementById('localVideo');
                        if (track.enabled) {
                            localVidEl.style.display = 'block'; // Камера ВКЛ — показываем окно
                        } else {
                            localVidEl.style.display = 'none';  // Камера ВЫКЛ — убираем окно полностью
                        }
                        // ----------------------------------------------

                        // ОБНОВЛЯЕМ БАЗУ ДАННЫХ (Это у тебя уже было)
                        if(this.currentCallId) {
                            const field = this.isCaller ? 'callerMuted' : 'calleeMuted';
                            window.fbSet(window.fbDoc(window.db, "calls", this.currentCallId), { 
                                [field]: !track.enabled 
                            }, { merge: true });
                        }

                        // МЕНЯЕМ ИКОНКУ КНОПКИ (Это тоже было)
                        const btn = document.getElementById('btnToggleCam');
                        if (track.enabled) {
                            btn.classList.remove('off'); btn.innerHTML = this.icons.cam;
                        } else {
                            btn.classList.add('off'); btn.innerHTML = this.icons.camOff;
                        }
                    }
                }

            }; // <-- close window.CallSystem object to prevent syntax errors

            // --- 14. UPDATED ADMIN: BLUE & EDIT/DELETE ---
            // Update AdminSystem init to apply blue mode
            const originalAdminInit = window.AdminSystem.init;
            window.AdminSystem.init = function(user) {
                originalAdminInit.call(this, user);
                if (user && user.email === 'voxtek@voxtek.net') {
                    const panel = document.getElementById('adminPanel');
                    panel.classList.add('blue-mode');
                    panel.querySelector('h3').textContent = "/// SYSTEM OVERLORD ///";
                    document.getElementById('adminToggleBtn').style.borderColor = "var(--vox-cyan)";
                    document.getElementById('adminToggleBtn').style.color = "var(--vox-cyan)";
                }
            }; 
            
            // Add Message Management to AdminSystem
            window.AdminSystem.deleteMessage = function(col, id) {
                if(confirm("PERMANENTLY DELETE RECORD?")) {
                     window.node_deleteDoc ? window.node_deleteDoc(window.fbDoc(window.db, col, id)) : 
                     window.fbDelete(window.fbDoc(window.db, col, id));
                     voxNotify("RECORD EXPUNGED", "success");
                }
            };
            
            window.AdminSystem.editMessage = async function(col, id, oldText) {
                const newText = await prompt("REWRITE HISTORY:", oldText);
                if(newText && newText !== oldText) {
                    window.fbSet(window.fbDoc(window.db, col, id), { text: newText }, { merge: true });
                    voxNotify("REALITY UPDATED", "success");
                }
            };
            
            // Hook into CloudSystem to Render Admin Tools for Messages
            // We override the listener inside loadChat slightly by injecting tools after render
            // Note: Since we can't easily inject into the middle of your existing listener without re-writing it entirely,
            // We will use a MutationObserver to watch the chat feed and add buttons if Admin.
            
            const chatObserver = new MutationObserver((mutations) => {
                if(window.auth.currentUser && window.auth.currentUser.email === 'voxtek@voxtek.net') {
                    mutations.forEach(mut => {
                        mut.addedNodes.forEach(node => {
                            if(node.classList && node.classList.contains('msg-wrapper')) {
                                // It's a message, add tools
                                // We need to fetch the ID. The original code didn't save ID in DOM.
                                // Quick fix: The listener needs to put ID in dataset.
                                // Since we can't change the listener easily above without copy-paste, 
                                // let's assume we click the message to moderate as Admin.
                                
                                node.addEventListener('contextmenu', async (e) => {
                                    e.preventDefault();
                                    const msgId = node.dataset.id; // Берем ID, который мы добавили
                                    if (!msgId) return voxNotify("ERROR: NO ID FOUND", "error");

                                    const action = await prompt("ADMIN ACTION (ID: " + msgId.substr(0,4) + "):\n1. Delete\n2. Edit\nType 1 or 2");
                                    
                                    // Определяем коллекцию (Глобальный чат или Личный)
                                    const col = MessengerUI.currentChat === 'global' ? 'messages_global' : 'messages_private';

                                    if (action === '1') {
                                        AdminSystem.deleteMessage(col, msgId);
                                    } else if (action === '2') {
                                        // Берем старый текст из пузыря сообщения
                                        const oldText = node.querySelector('.msg-bubble').innerText;
                                        AdminSystem.editMessage(col, msgId, oldText);
                                    }
                                });
                            }
                        });
                    });
                }
            });
            chatObserver.observe(document.getElementById('chatFeed'), { childList: true });
            
            // Start Listening for calls on boot
            setTimeout(() => {
                if(window.auth.currentUser) CallSystem.listenGlobal();
            }, 3000);

// --- SAFE INITIALIZATION (ANTI-SPAM & RACE CONDITION FIX) ---
            let systemLoaded = false; // Глобальный флаг защиты от повторного запуска

            const initVoxSystem = () => {
                // Если система уже загружена, выходим, чтобы не дублировать уведомления
                if (systemLoaded) return;

                // Проверяем, загрузился ли Firebase (fbCol)
                if (window.fbCol && window.auth && window.db) {
                    
                    systemLoaded = true; // Ставим флаг: "Система загружена"

                    // 1. Запускаем авторизацию (проверку входа)
                    if(window.AuthSystem) AuthSystem.init();
                    
                    // 2. Запускаем глобальный слушатель сообщений (для бейджиков "unread")
                    if(window.auth.currentUser) {
                         try {
                             const qAll = window.fbQuery(
                                 window.fbCol(window.db, "messages_private"),
                                 window.fbWhere("chatId", ">=", window.auth.currentUser.uid),
                                 window.fbOrder("chatId"),
                                 window.fbOrder("createdAt", "desc"),
                                 window.fbLimit(20)
                             );
                             
                             window.fbSnap(qAll, (snapshot) => {
                                snapshot.docChanges().forEach((change) => {
                                    if (change.type === "added") {
                                        const data = change.doc.data();
                                        // Если сообщение мне (часть chatId) и НЕ от меня
                                        if (data.chatId.includes(window.auth.currentUser.uid) && data.uid !== window.auth.currentUser.uid) {
                                            // Если мы сейчас не в этом чате, ставим бейдж
                                            if (MessengerUI.currentChat !== data.chatId) {
                                                MessengerUI.updateUnread(data.uid);
                                            }
                                        }
                                    }
                                });
                             });
                         } catch (e) { 
                             console.log("Waiting for auth to stabilize..."); 
                         }
                    }

                    // 3. Запускаем Админские Алерты (красные окна)
                    if(window.AdminSystem) AdminSystem.listenForAlerts();
                    
                    console.log("VOXTEK SYSTEMS: FULLY SYNCHRONIZED");
                    
                } else {
                    // Если Firebase еще не готов, ждем 100мс и пробуем снова
                    console.log("System Loading...");
                    setTimeout(initVoxSystem, 100);
                }
            };

            // Запускаем процесс
            initVoxSystem();
        })();
    </script>
</body>
</html>
